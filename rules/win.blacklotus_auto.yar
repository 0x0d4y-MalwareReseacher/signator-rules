rule win_blacklotus_auto {

    meta:
        author = "Felix Bilstein - yara-signator at cocacoding dot com"
        date = "2023-07-11"
        version = "1"
        description = "Detects win.blacklotus."
        info = "autogenerated rule brought to you by yara-signator"
        tool = "yara-signator v0.6.0"
        signator_config = "callsandjumps;datarefs;binvalue"
        malpedia_reference = "https://malpedia.caad.fkie.fraunhofer.de/details/win.blacklotus"
        malpedia_rule_date = "20230705"
        malpedia_hash = "42d0574f4405bd7d2b154d321d345acb18834a41"
        malpedia_version = "20230715"
        malpedia_license = "CC BY-SA 4.0"
        malpedia_sharing = "TLP:WHITE"

    /* DISCLAIMER
     * The strings used in this rule have been automatically selected from the
     * disassembly of memory dumps and unpacked files, using YARA-Signator.
     * The code and documentation is published here:
     * https://github.com/fxb-cocacoding/yara-signator
     * As Malpedia is used as data source, please note that for a given
     * number of families, only single samples are documented.
     * This likely impacts the degree of generalization these rules will offer.
     * Take the described generation method also into consideration when you
     * apply the rules in your use cases and assign them confidence levels.
     */


    strings:
        $sequence_0 = { 498bcf e8???????? 448bc0 498bd7 4d03c0 488bce }
            // n = 6, score = 100
            //   498bcf               | lea                 ecx, [ecx + 4]
            //   e8????????           |                     
            //   448bc0               | dec                 ecx
            //   498bd7               | sub                 eax, 1
            //   4d03c0               | jne                 0x8cb
            //   488bce               | mov                 al, byte ptr [edx + ecx - 1]

        $sequence_1 = { 4c897020 55 488d68c8 4881ec30010000 4c8bd1 }
            // n = 5, score = 100
            //   4c897020             | mov                 cl, dh
            //   55                   | mov                 bl, al
            //   488d68c8             | mov                 dl, 0xe
            //   4881ec30010000       | inc                 eax
            //   4c8bd1               | mov                 cl, ch

        $sequence_2 = { 488b0d???????? 4c8d054e140100 488bd7 488bd8 e8???????? 488b05???????? 488bcb }
            // n = 7, score = 100
            //   488b0d????????       |                     
            //   4c8d054e140100       | test                eax, eax
            //   488bd7               | js                  0x79a
            //   488bd8               | dec                 eax
            //   e8????????           |                     
            //   488b05????????       |                     
            //   488bcb               | mov                 ecx, dword ptr [esp + 0x68]

        $sequence_3 = { 8b0c91 498bd2 4903c9 e8???????? }
            // n = 4, score = 100
            //   8b0c91               | mov                 edi, eax
            //   498bd2               | dec                 eax
            //   4903c9               | mov                 ecx, dword ptr [ebp + 0x30]
            //   e8????????           |                     

        $sequence_4 = { 4585d2 743f 8b05???????? 4103c1 }
            // n = 4, score = 100
            //   4585d2               | lea                 ecx, [esp + 0x40]
            //   743f                 | dec                 eax
            //   8b05????????         |                     
            //   4103c1               | mov                 dword ptr [esp + 0x20], ecx

        $sequence_5 = { 4883ec20 488d7910 8bea 488b1f 33f6 }
            // n = 5, score = 100
            //   4883ec20             | mov                 dword ptr [ebp - 0x44], 0x73195d64
            //   488d7910             | mov                 dword ptr [ebp - 0x40], 0xdc4f8160
            //   8bea                 | mov                 dword ptr [ebp - 0x3c], 0x88902a22
            //   488b1f               | mov                 dword ptr [ebp - 0x38], 0x14b8ee46
            //   33f6                 | mov                 dword ptr [ebp - 0x41], 0x558e4f7

        $sequence_6 = { 488bd9 b10e e8???????? 8a4b02 40b70d }
            // n = 5, score = 100
            //   488bd9               | mov                 ecx, dword ptr [esp + 0x68]
            //   b10e                 | dec                 esp
            //   e8????????           |                     
            //   8a4b02               | lea                 eax, [esp + 0x70]
            //   40b70d               | dec                 eax

        $sequence_7 = { 410f47f7 8bc6 488b742460 4883c430 415f }
            // n = 5, score = 100
            //   410f47f7             | ja                  0x130a
            //   8bc6                 | dec                 esp
            //   488b742460           | mov                 eax, edx
            //   4883c430             | inc                 ecx
            //   415f                 | inc                 edx

        $sequence_8 = { 4923d3 4803d1 440fb74a0c 440fb7520e }
            // n = 4, score = 100
            //   4923d3               | cmp                 esi, edi
            //   4803d1               | jb                  0x5e0
            //   440fb74a0c           | jmp                 0x631
            //   440fb7520e           | dec                 eax

        $sequence_9 = { 6642837cc11010 0f859d000000 428b54c114 41bbffffff7f 4923d3 }
            // n = 5, score = 100
            //   6642837cc11010       | xor                 edi, edi
            //   0f859d000000         | inc                 ecx
            //   428b54c114           | push                esi
            //   41bbffffff7f         | dec                 eax
            //   4923d3               | mov                 ebp, esp

    condition:
        7 of them and filesize < 181248
}