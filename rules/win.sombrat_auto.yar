rule win_sombrat_auto {

    meta:
        author = "Felix Bilstein - yara-signator at cocacoding dot com"
        date = "2022-11-21"
        version = "1"
        description = "Detects win.sombrat."
        info = "autogenerated rule brought to you by yara-signator"
        tool = "yara-signator v0.6.0"
        signator_config = "callsandjumps;datarefs;binvalue"
        malpedia_reference = "https://malpedia.caad.fkie.fraunhofer.de/details/win.sombrat"
        malpedia_rule_date = "20221118"
        malpedia_hash = "e0702e2e6d1d00da65c8a29a4ebacd0a4c59e1af"
        malpedia_version = "20221125"
        malpedia_license = "CC BY-SA 4.0"
        malpedia_sharing = "TLP:WHITE"

    /* DISCLAIMER
     * The strings used in this rule have been automatically selected from the
     * disassembly of memory dumps and unpacked files, using YARA-Signator.
     * The code and documentation is published here:
     * https://github.com/fxb-cocacoding/yara-signator
     * As Malpedia is used as data source, please note that for a given
     * number of families, only single samples are documented.
     * This likely impacts the degree of generalization these rules will offer.
     * Take the described generation method also into consideration when you
     * apply the rules in your use cases and assign them confidence levels.
     */


    strings:
        $sequence_0 = { 7505 4c8bca eb22 41807a1900 4c8b4a08 7504 4d894a08 }
            // n = 7, score = 200
            //   7505                 | mov                 al, 1
            //   4c8bca               | mov                 al, 0x4f
            //   eb22                 | mov                 byte ptr [ebp - 0x20], 0x24
            //   41807a1900           | ja                  0x2d9
            //   4c8b4a08             | dec                 esp
            //   7504                 | cmp                 dword ptr [edi + 0x30], esp
            //   4d894a08             | jne                 0x2d9

        $sequence_1 = { 4889b424b0000000 488d442428 483bc8 740a 488d542428 e8???????? 498d7e08 }
            // n = 7, score = 200
            //   4889b424b0000000     | dec                 eax
            //   488d442428           | mov                 dword ptr [esp + 0x20], eax
            //   483bc8               | mov                 edx, esi
            //   740a                 | dec                 eax
            //   488d542428           | mov                 ecx, edi
            //   e8????????           |                     
            //   498d7e08             | inc                 ecx

        $sequence_2 = { bd06000000 488d7b38 488d0536fd0200 483947f0 741a 488b0f 4885c9 }
            // n = 7, score = 200
            //   bd06000000           | dec                 eax
            //   488d7b38             | lea                 eax, [0x599b8]
            //   488d0536fd0200       | dec                 eax
            //   483947f0             | mov                 dword ptr [esp + 0x20], eax
            //   741a                 | inc                 ecx
            //   488b0f               | mov                 ecx, 0x794
            //   4885c9               | dec                 eax

        $sequence_3 = { e8???????? c6843b3801000000 488b5c2430 488bc7 488b7c2448 488b6c2438 488b742440 }
            // n = 7, score = 200
            //   e8????????           |                     
            //   c6843b3801000000     | mov                 eax, dword ptr [ebx]
            //   488b5c2430           | dec                 eax
            //   488bc7               | add                 dword ptr [eax + 0x10], edi
            //   488b7c2448           | dec                 eax
            //   488b6c2438           | mov                 eax, dword ptr [ebx]
            //   488b742440           | inc                 esp

        $sequence_4 = { 57 4883ec40 488360e000 498be8 488360e800 488bf1 4883cbff }
            // n = 7, score = 200
            //   57                   | dec                 eax
            //   4883ec40             | mov                 dword ptr [edx], eax
            //   488360e000           | dec                 eax
            //   498be8               | mov                 dword ptr [eax + 8], edx
            //   488360e800           | jmp                 0xac1
            //   488bf1               | dec                 eax
            //   4883cbff             | mov                 edx, ecx

        $sequence_5 = { 83c801 85c0 0f853e050000 418b86f4000000 85c0 0f8520010000 }
            // n = 6, score = 200
            //   83c801               | add                 edx, ecx
            //   85c0                 | add                 ebp, edx
            //   0f853e050000         | rol                 edi, 0xa
            //   418b86f4000000       | inc                 esp
            //   85c0                 | lea                 ebx, [edx + 0x50a28be6]
            //   0f8520010000         | inc                 esp

        $sequence_6 = { 7568 488d7944 8d6a10 44330f 488d7ffc 418bc1 458bc1 }
            // n = 7, score = 200
            //   7568                 | mov                 ecx, 0x10
            //   488d7944             | movzx               edx, word ptr [eax + 0x1714]
            //   8d6a10               | inc                 dword ptr [eax + 0x28]
            //   44330f               | sub                 cl, dl
            //   488d7ffc             | add                 dword ptr [eax + 0x1714], -0xd
            //   418bc1               | movzx               ecx, byte ptr [eax + 0x1711]
            //   458bc1               | inc                 ecx

        $sequence_7 = { 33f6 884c2453 4d85f6 7410 498b0e 4885c9 7408 }
            // n = 7, score = 200
            //   33f6                 | jb                  0x858
            //   884c2453             | dec                 esp
            //   4d85f6               | mov                 eax, dword ptr [ecx - 8]
            //   7410                 | dec                 eax
            //   498b0e               | add                 edx, 0x27
            //   4885c9               | dec                 eax
            //   7408                 | mov                 ecx, dword ptr [ebx + 0xb0]

        $sequence_8 = { ba01000000 488bcb e8???????? 41b032 b202 488bcb e8???????? }
            // n = 7, score = 200
            //   ba01000000           | mov                 eax, esi
            //   488bcb               | dec                 eax
            //   e8????????           |                     
            //   41b032               | mov                 dword ptr [esp + 0x20], eax
            //   b202                 | mov                 edx, 1
            //   488bcb               | inc                 ecx
            //   e8????????           |                     

        $sequence_9 = { 85c0 751e 488d4f68 33d2 e8???????? 33d2 488d4d88 }
            // n = 7, score = 200
            //   85c0                 | je                  0x104c
            //   751e                 | mov                 edx, 0x270
            //   488d4f68             | dec                 eax
            //   33d2                 | mov                 ecx, esi
            //   e8????????           |                     
            //   33d2                 | dec                 eax
            //   488d4d88             | mov                 ebx, dword ptr [esp + 0x30]

    condition:
        7 of them and filesize < 1466368
}