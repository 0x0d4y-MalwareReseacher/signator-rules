rule win_winnti_auto {

    meta:
        author = "Felix Bilstein - yara-signator at cocacoding dot com"
        date = "2022-04-08"
        version = "1"
        description = "Describes win.winnti."
        info = "autogenerated rule brought to you by yara-signator"
        tool = "yara-signator v0.6.0"
        signator_config = "callsandjumps;datarefs;binvalue"
        malpedia_reference = "https://malpedia.caad.fkie.fraunhofer.de/details/win.winnti"
        malpedia_rule_date = "20220405"
        malpedia_hash = "ecd38294bd47d5589be5cd5490dc8bb4804afc2a"
        malpedia_version = ""
        malpedia_license = "CC BY-SA 4.0"
        malpedia_sharing = "TLP:WHITE"

    /* DISCLAIMER
     * The strings used in this rule have been automatically selected from the
     * disassembly of memory dumps and unpacked files, using YARA-Signator.
     * The code and documentation is published here:
     * https://github.com/fxb-cocacoding/yara-signator
     * As Malpedia is used as data source, please note that for a given
     * number of families, only single samples are documented.
     * This likely impacts the degree of generalization these rules will offer.
     * Take the described generation method also into consideration when you
     * apply the rules in your use cases and assign them confidence levels.
     */


    strings:
        $sequence_0 = { 8d6c2901 8b4c2428 50 51 }
            // n = 4, score = 200
            //   8d6c2901             | lea                 ebp, dword ptr [ecx + ebp + 1]
            //   8b4c2428             | mov                 ecx, dword ptr [esp + 0x28]
            //   50                   | push                eax
            //   51                   | push                ecx

        $sequence_1 = { 03f0 3bf3 7cc8 8b6c2410 55 }
            // n = 5, score = 200
            //   03f0                 | add                 esi, eax
            //   3bf3                 | cmp                 esi, ebx
            //   7cc8                 | jl                  0xffffffca
            //   8b6c2410             | mov                 ebp, dword ptr [esp + 0x10]
            //   55                   | push                ebp

        $sequence_2 = { 33f6 ff15???????? 8a842484000000 84c0 }
            // n = 4, score = 200
            //   33f6                 | xor                 esi, esi
            //   ff15????????         |                     
            //   8a842484000000       | mov                 al, byte ptr [esp + 0x84]
            //   84c0                 | test                al, al

        $sequence_3 = { 663dffff 751f 8b4d00 51 6a01 ff15???????? }
            // n = 6, score = 200
            //   663dffff             | cmp                 ax, 0xffff
            //   751f                 | jne                 0x21
            //   8b4d00               | mov                 ecx, dword ptr [ebp]
            //   51                   | push                ecx
            //   6a01                 | push                1
            //   ff15????????         |                     

        $sequence_4 = { 83c404 85f6 750c 5e 5d 83c8ff }
            // n = 6, score = 200
            //   83c404               | add                 esp, 4
            //   85f6                 | test                esi, esi
            //   750c                 | jne                 0xe
            //   5e                   | pop                 esi
            //   5d                   | pop                 ebp
            //   83c8ff               | or                  eax, 0xffffffff

        $sequence_5 = { 51 52 c74424280c000000 c744243001000000 c744242c00000000 ffd6 85c0 }
            // n = 7, score = 200
            //   51                   | push                ecx
            //   52                   | push                edx
            //   c74424280c000000     | mov                 dword ptr [esp + 0x28], 0xc
            //   c744243001000000     | mov                 dword ptr [esp + 0x30], 1
            //   c744242c00000000     | mov                 dword ptr [esp + 0x2c], 0
            //   ffd6                 | call                esi
            //   85c0                 | test                eax, eax

        $sequence_6 = { 68???????? 68???????? 89460c 895e44 }
            // n = 4, score = 200
            //   68????????           |                     
            //   68????????           |                     
            //   89460c               | mov                 dword ptr [esi + 0xc], eax
            //   895e44               | mov                 dword ptr [esi + 0x44], ebx

        $sequence_7 = { 57 51 6a03 89742434 89742438 c68424b000000000 }
            // n = 6, score = 200
            //   57                   | push                edi
            //   51                   | push                ecx
            //   6a03                 | push                3
            //   89742434             | mov                 dword ptr [esp + 0x34], esi
            //   89742438             | mov                 dword ptr [esp + 0x38], esi
            //   c68424b000000000     | mov                 byte ptr [esp + 0xb0], 0

        $sequence_8 = { 90 488d05e6240100 488903 488b7b68 4885ff 7410 488bcf }
            // n = 7, score = 100
            //   90                   | dec                 eax
            //   488d05e6240100       | arpl                word ptr [eax + 0x14], cx
            //   488903               | dec                 eax
            //   488b7b68             | imul                edi, edi, 0x38
            //   4885ff               | dec                 eax
            //   7410                 | mov                 eax, dword ptr [ebp - 0x61]
            //   488bcf               | dec                 eax

        $sequence_9 = { e8???????? 33d2 448d4202 488bcb e8???????? 90 488d05e6240100 }
            // n = 7, score = 100
            //   e8????????           |                     
            //   33d2                 | je                  0x28
            //   448d4202             | dec                 eax
            //   488bcb               | mov                 edx, eax
            //   e8????????           |                     
            //   90                   | dec                 eax
            //   488d05e6240100       | mov                 eax, dword ptr [eax]

        $sequence_10 = { 488bd1 48c1fa10 498b8680000000 0fb7c9 48c1e105 488b04d0 }
            // n = 6, score = 100
            //   488bd1               | mov                 dword ptr [esp + 0x50], ebx
            //   48c1fa10             | dec                 eax
            //   498b8680000000       | mov                 dword ptr [esp + 0x48], ebx
            //   0fb7c9               | mov                 dword ptr [esp + 0x40], ebx
            //   48c1e105             | mov                 dword ptr [esp + 0x38], 1
            //   488b04d0             | mov                 dword ptr [esp + 0x30], ebx

        $sequence_11 = { 668932 488d4c2478 ba04010000 ff15???????? }
            // n = 4, score = 100
            //   668932               | inc                 ecx
            //   488d4c2478           | sub                 al, bh
            //   ba04010000           | inc                 ecx
            //   ff15????????         |                     

        $sequence_12 = { 837a1400 7426 488bd0 488b00 48634814 }
            // n = 5, score = 100
            //   837a1400             | arpl                word ptr [ecx + edi + 4], ax
            //   7426                 | dec                 edx
            //   488bd0               | lea                 eax, dword ptr [ecx + eax]
            //   488b00               | dec                 eax
            //   48634814             | add                 esi, eax

        $sequence_13 = { 895c2450 48895c2448 895c2440 c744243801000000 895c2430 895c2428 }
            // n = 6, score = 100
            //   895c2450             | mov                 byte ptr [eax + 5], 1
            //   48895c2448           | inc                 ecx
            //   895c2440             | mov                 byte ptr [eax + 4], al
            //   c744243801000000     | dec                 eax
            //   895c2430             | lea                 edx, dword ptr [0xed3]
            //   895c2428             | dec                 eax

        $sequence_14 = { 488d15d30e0000 488d4c2440 ff15???????? c744242804000000 488d8424b8000000 4889442420 }
            // n = 6, score = 100
            //   488d15d30e0000       | mov                 esp, ecx
            //   488d4c2440           | inc                 esp
            //   ff15????????         |                     
            //   c744242804000000     | mov                 dword ptr [ebp + 0x3b0], esi
            //   488d8424b8000000     | inc                 ebp
            //   4889442420           | mov                 edi, esi

        $sequence_15 = { 442bc2 4503c2 33d2 8bc1 }
            // n = 4, score = 100
            //   442bc2               | inc                 ecx
            //   4503c2               | pop                 edi
            //   33d2                 | inc                 esp
            //   8bc1                 | sub                 eax, edx

        $sequence_16 = { 486bff38 488b459f 488b4c0720 4c8b6dbf 418b4504 }
            // n = 5, score = 100
            //   486bff38             | jmp                 0x1b
            //   488b459f             | mov                 word ptr [edx], si
            //   488b4c0720           | dec                 eax
            //   4c8b6dbf             | lea                 ecx, dword ptr [esp + 0x78]
            //   418b4504             | mov                 edx, 0x104

        $sequence_17 = { 7514 33c0 4881c478040000 415f }
            // n = 4, score = 100
            //   7514                 | jne                 0x16
            //   33c0                 | xor                 eax, eax
            //   4881c478040000       | dec                 eax
            //   415f                 | add                 esp, 0x478

        $sequence_18 = { 488b05???????? 4833c4 4889842430010000 83fa01 756a }
            // n = 5, score = 100
            //   488b05????????       |                     
            //   4833c4               | mov                 dword ptr [esp + 0x28], ebx
            //   4889842430010000     | inc                 esp
            //   83fa01               | mov                 esi, eax
            //   756a                 | jmp                 0x60

        $sequence_19 = { f2ae 48f7d1 4c8d41ff 488bd3 498d4e28 }
            // n = 5, score = 100
            //   f2ae                 | mov                 ecx, dword ptr [edi + eax + 0x20]
            //   48f7d1               | dec                 esp
            //   4c8d41ff             | mov                 ebp, dword ptr [ebp - 0x41]
            //   488bd3               | inc                 ecx
            //   498d4e28             | mov                 eax, dword ptr [ebp + 4]

        $sequence_20 = { 4881ec78040000 4533f6 448bea 4c8be1 4489b5b0030000 458bfe 418bf6 }
            // n = 7, score = 100
            //   4881ec78040000       | inc                 ebp
            //   4533f6               | add                 eax, edx
            //   448bea               | xor                 edx, edx
            //   4c8be1               | mov                 eax, ecx
            //   4489b5b0030000       | dec                 eax
            //   458bfe               | sub                 esp, 0x478
            //   418bf6               | inc                 ebp

        $sequence_21 = { 4e63443904 4a8d0401 4803f0 eb19 }
            // n = 4, score = 100
            //   4e63443904           | inc                 ecx
            //   4a8d0401             | mov                 esi, esi
            //   4803f0               | dec                 ecx
            //   eb19                 | inc                 ecx

        $sequence_22 = { ffc1 7416 488b9680000000 4c63c1 488bc8 49c1e003 e8???????? }
            // n = 7, score = 100
            //   ffc1                 | push                eax
            //   7416                 | rep movsb           byte ptr es:[edi], byte ptr [esi]
            //   488b9680000000       | mov                 ecx, dword ptr [esp + 0x164]
            //   4c63c1               | push                ecx
            //   488bc8               | push                ebp
            //   49c1e003             | cmp                 dword ptr [edx + 0x14], 0
            //   e8????????           |                     

        $sequence_23 = { 49ffc1 412ac7 41c6400501 41884004 }
            // n = 4, score = 100
            //   49ffc1               | xor                 esi, esi
            //   412ac7               | inc                 esp
            //   41c6400501           | mov                 ebp, edx
            //   41884004             | dec                 esp

    condition:
        7 of them and filesize < 1581056
}