rule win_blackmagic_auto {

    meta:
        author = "Felix Bilstein - yara-signator at cocacoding dot com"
        date = "2023-07-11"
        version = "1"
        description = "Detects win.blackmagic."
        info = "autogenerated rule brought to you by yara-signator"
        tool = "yara-signator v0.6.0"
        signator_config = "callsandjumps;datarefs;binvalue"
        malpedia_reference = "https://malpedia.caad.fkie.fraunhofer.de/details/win.blackmagic"
        malpedia_rule_date = "20230705"
        malpedia_hash = "42d0574f4405bd7d2b154d321d345acb18834a41"
        malpedia_version = "20230715"
        malpedia_license = "CC BY-SA 4.0"
        malpedia_sharing = "TLP:WHITE"

    /* DISCLAIMER
     * The strings used in this rule have been automatically selected from the
     * disassembly of memory dumps and unpacked files, using YARA-Signator.
     * The code and documentation is published here:
     * https://github.com/fxb-cocacoding/yara-signator
     * As Malpedia is used as data source, please note that for a given
     * number of families, only single samples are documented.
     * This likely impacts the degree of generalization these rules will offer.
     * Take the described generation method also into consideration when you
     * apply the rules in your use cases and assign them confidence levels.
     */


    strings:
        $sequence_0 = { 4883c430 5f 49ffa0a8000000 48897c2440 e8???????? 4c8b13 4c8d0dc8bc0700 }
            // n = 7, score = 100
            //   4883c430             | mov                 ecx, dword ptr [ecx + ebx + 0x48]
            //   5f                   | dec                 eax
            //   49ffa0a8000000       | mov                 eax, dword ptr [ecx + 0x38]
            //   48897c2440           | or                  edi, 4
            //   e8????????           |                     
            //   4c8b13               | mov                 dword ptr [esp + 0x30], edi
            //   4c8d0dc8bc0700       | dec                 ebp

        $sequence_1 = { 488d05ebb0fcff 0fb68401c0120700 4433c0 41c1e008 0fb6c2 488d0dd2b0fcff 0fb68408c0120700 }
            // n = 7, score = 100
            //   488d05ebb0fcff       | xor                 ecx, eax
            //   0fb68401c0120700     | inc                 ecx
            //   4433c0               | mov                 eax, ebp
            //   41c1e008             | add                 edi, edx
            //   0fb6c2               | mov                 edx, dword ptr [ebp + 0x77]
            //   488d0dd2b0fcff       | add                 dword ptr [esp + 4], edi
            //   0fb68408c0120700     | mov                 ecx, edx

        $sequence_2 = { 488bce ff5040 4883ff20 7312 488bcf b801000000 d3e0 }
            // n = 7, score = 100
            //   488bce               | mov                 eax, edi
            //   ff5040               | int3                
            //   4883ff20             | dec                 esp
            //   7312                 | mov                 eax, ebx
            //   488bcf               | dec                 eax
            //   b801000000           | lea                 edx, [0x76779]
            //   d3e0                 | dec                 eax

        $sequence_3 = { e8???????? 83c8ff 4883c420 5b c3 488b8948050000 4883f9ff }
            // n = 7, score = 100
            //   e8????????           |                     
            //   83c8ff               | dec                 eax
            //   4883c420             | cmp                 eax, 0x1000
            //   5b                   | jb                  0x16cf
            //   c3                   | dec                 eax
            //   488b8948050000       | mov                 eax, dword ptr [ebp - 0x29]
            //   4883f9ff             | dec                 esp

        $sequence_4 = { 4883ec30 48c7442420feffffff 48895c2448 4889742450 488bfa 488bd9 488d05fe8f0600 }
            // n = 7, score = 100
            //   4883ec30             | inc                 esp
            //   48c7442420feffffff     | mov    byte ptr [esp + 0xb9], al
            //   48895c2448           | jmp                 0x44a
            //   4889742450           | dec                 eax
            //   488bfa               | mov                 edi, ebx
            //   488bd9               | dec                 eax
            //   488d05fe8f0600       | mov                 dword ptr [esp + 0xb0], ebx

        $sequence_5 = { e8???????? 488d8c2498010000 e8???????? 488d8c2478010000 e8???????? 80bc247001000000 7407 }
            // n = 7, score = 100
            //   e8????????           |                     
            //   488d8c2498010000     | mov                 eax, esi
            //   e8????????           |                     
            //   488d8c2478010000     | dec                 eax
            //   e8????????           |                     
            //   80bc247001000000     | mov                 eax, dword ptr [ebx + 0x18]
            //   7407                 | dec                 eax

        $sequence_6 = { 488d4c2430 e8???????? 488bd0 488d4c2420 e8???????? eb22 488d158d090300 }
            // n = 7, score = 100
            //   488d4c2430           | dec                 eax
            //   e8????????           |                     
            //   488bd0               | lea                 ebx, [0x68bfd]
            //   488d4c2420           | movzx               eax, byte ptr [ebx]
            //   e8????????           |                     
            //   eb22                 | dec                 al
            //   488d158d090300       | cmp                 al, 0x7d

        $sequence_7 = { 488bc6 488b4df0 4833cc e8???????? 4c8d5c2460 498b5b28 498b7338 }
            // n = 7, score = 100
            //   488bc6               | xor                 ecx, ecx
            //   488b4df0             | dec                 eax
            //   4833cc               | mov                 dword ptr [ebp - 0x51], ecx
            //   e8????????           |                     
            //   4c8d5c2460           | dec                 eax
            //   498b5b28             | mov                 dword ptr [ebp - 0x49], ecx
            //   498b7338             | dec                 eax

        $sequence_8 = { 4881ecc0000000 48c745a7feffffff 48899c2418010000 488b05???????? 4833c4 48894517 498bd8 }
            // n = 7, score = 100
            //   4881ecc0000000       | dec                 eax
            //   48c745a7feffffff     | lea                 ebx, [0x620f7]
            //   48899c2418010000     | mov                 edi, 8
            //   488b05????????       |                     
            //   4833c4               | dec                 eax
            //   48894517             | mov                 ecx, ebx
            //   498bd8               | dec                 eax

        $sequence_9 = { 48c745ef0f000000 48895de7 c645d700 488b450f 4883f810 724c 48ffc0 }
            // n = 7, score = 100
            //   48c745ef0f000000     | push                esi
            //   48895de7             | inc                 ecx
            //   c645d700             | push                edi
            //   488b450f             | dec                 eax
            //   4883f810             | lea                 ebp, [eax - 0x5f]
            //   724c                 | dec                 eax
            //   48ffc0               | sub                 esp, 0xe0

    condition:
        7 of them and filesize < 1416192
}