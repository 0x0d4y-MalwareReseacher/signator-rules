rule win_rovnix_auto {

    meta:
        author = "Felix Bilstein - yara-signator at cocacoding dot com"
        date = "2023-01-25"
        version = "1"
        description = "Detects win.rovnix."
        info = "autogenerated rule brought to you by yara-signator"
        tool = "yara-signator v0.6.0"
        signator_config = "callsandjumps;datarefs;binvalue"
        malpedia_reference = "https://malpedia.caad.fkie.fraunhofer.de/details/win.rovnix"
        malpedia_rule_date = "20230124"
        malpedia_hash = "2ee0eebba83dce3d019a90519f2f972c0fcf9686"
        malpedia_version = "20230125"
        malpedia_license = "CC BY-SA 4.0"
        malpedia_sharing = "TLP:WHITE"

    /* DISCLAIMER
     * The strings used in this rule have been automatically selected from the
     * disassembly of memory dumps and unpacked files, using YARA-Signator.
     * The code and documentation is published here:
     * https://github.com/fxb-cocacoding/yara-signator
     * As Malpedia is used as data source, please note that for a given
     * number of families, only single samples are documented.
     * This likely impacts the degree of generalization these rules will offer.
     * Take the described generation method also into consideration when you
     * apply the rules in your use cases and assign them confidence levels.
     */


    strings:
        $sequence_0 = { be???????? 8b15???????? 83e7f0 89542418 83c710 }
            // n = 5, score = 800
            //   be????????           |                     
            //   8b15????????         |                     
            //   83e7f0               | and                 edi, 0xfffffff0
            //   89542418             | mov                 dword ptr [esp + 0x18], edx
            //   83c710               | add                 edi, 0x10

        $sequence_1 = { 7405 57 6a00 ffd2 89442408 }
            // n = 5, score = 800
            //   7405                 | je                  7
            //   57                   | push                edi
            //   6a00                 | push                0
            //   ffd2                 | call                edx
            //   89442408             | mov                 dword ptr [esp + 8], eax

        $sequence_2 = { 2bc3 ab e2fa 61 }
            // n = 4, score = 800
            //   2bc3                 | sub                 eax, ebx
            //   ab                   | stosd               dword ptr es:[edi], eax
            //   e2fa                 | loop                0xfffffffc
            //   61                   | popal               

        $sequence_3 = { 8bf8 83c335 c1e902 ad 2bc3 ab }
            // n = 6, score = 800
            //   8bf8                 | mov                 edi, eax
            //   83c335               | add                 ebx, 0x35
            //   c1e902               | shr                 ecx, 2
            //   ad                   | lodsd               eax, dword ptr [esi]
            //   2bc3                 | sub                 eax, ebx
            //   ab                   | stosd               dword ptr es:[edi], eax

        $sequence_4 = { 60 bf40090000 be???????? 8b15???????? }
            // n = 4, score = 500
            //   60                   | pushal              
            //   bf40090000           | mov                 edi, 0x940
            //   be????????           |                     
            //   8b15????????         |                     

        $sequence_5 = { 85c0 e8???????? 8be5 5d }
            // n = 4, score = 400
            //   85c0                 | test                eax, eax
            //   e8????????           |                     
            //   8be5                 | mov                 esp, ebp
            //   5d                   | pop                 ebp

        $sequence_6 = { 8b7e10 eb06 8b5d0c 8b7d08 8bcf }
            // n = 5, score = 400
            //   8b7e10               | mov                 edi, dword ptr [esi + 0x10]
            //   eb06                 | jmp                 8
            //   8b5d0c               | mov                 ebx, dword ptr [ebp + 0xc]
            //   8b7d08               | mov                 edi, dword ptr [ebp + 8]
            //   8bcf                 | mov                 ecx, edi

        $sequence_7 = { 85c0 7405 8d4e1c 8908 8b4508 c7461801000000 8b4804 }
            // n = 7, score = 400
            //   85c0                 | test                eax, eax
            //   7405                 | je                  7
            //   8d4e1c               | lea                 ecx, [esi + 0x1c]
            //   8908                 | mov                 dword ptr [eax], ecx
            //   8b4508               | mov                 eax, dword ptr [ebp + 8]
            //   c7461801000000       | mov                 dword ptr [esi + 0x18], 1
            //   8b4804               | mov                 ecx, dword ptr [eax + 4]

        $sequence_8 = { 83f919 7703 83c220 85c0 7404 3bc2 }
            // n = 6, score = 400
            //   83f919               | cmp                 ecx, 0x19
            //   7703                 | ja                  5
            //   83c220               | add                 edx, 0x20
            //   85c0                 | test                eax, eax
            //   7404                 | je                  6
            //   3bc2                 | cmp                 eax, edx

        $sequence_9 = { 895dec 8b8680000000 3bc3 0f8434010000 03c1 }
            // n = 5, score = 400
            //   895dec               | mov                 dword ptr [ebp - 0x14], ebx
            //   8b8680000000         | mov                 eax, dword ptr [esi + 0x80]
            //   3bc3                 | cmp                 eax, ebx
            //   0f8434010000         | je                  0x13a
            //   03c1                 | add                 eax, ecx

        $sequence_10 = { 8d7e08 897f04 893f 894e14 }
            // n = 4, score = 400
            //   8d7e08               | lea                 edi, [esi + 8]
            //   897f04               | mov                 dword ptr [edi + 4], edi
            //   893f                 | mov                 dword ptr [edi], edi
            //   894e14               | mov                 dword ptr [esi + 0x14], ecx

        $sequence_11 = { ff17 3bc3 8945f8 0f8cb9000000 }
            // n = 4, score = 400
            //   ff17                 | call                dword ptr [edi]
            //   3bc3                 | cmp                 eax, ebx
            //   8945f8               | mov                 dword ptr [ebp - 8], eax
            //   0f8cb9000000         | jl                  0xbf

        $sequence_12 = { 8b4d08 83c304 8345f404 8b13 85d2 758d eb0a }
            // n = 7, score = 400
            //   8b4d08               | mov                 ecx, dword ptr [ebp + 8]
            //   83c304               | add                 ebx, 4
            //   8345f404             | add                 dword ptr [ebp - 0xc], 4
            //   8b13                 | mov                 edx, dword ptr [ebx]
            //   85d2                 | test                edx, edx
            //   758d                 | jne                 0xffffff8f
            //   eb0a                 | jmp                 0xc

        $sequence_13 = { 56 57 8b7d08 8b8f300a0000 }
            // n = 4, score = 400
            //   56                   | push                esi
            //   57                   | push                edi
            //   8b7d08               | mov                 edi, dword ptr [ebp + 8]
            //   8b8f300a0000         | mov                 ecx, dword ptr [edi + 0xa30]

        $sequence_14 = { 03c1 8d1c0a 8945f4 eb6d 7804 03d1 }
            // n = 6, score = 400
            //   03c1                 | add                 eax, ecx
            //   8d1c0a               | lea                 ebx, [edx + ecx]
            //   8945f4               | mov                 dword ptr [ebp - 0xc], eax
            //   eb6d                 | jmp                 0x6f
            //   7804                 | js                  6
            //   03d1                 | add                 edx, ecx

        $sequence_15 = { c745d800020000 8975d4 8975dc 8975e0 }
            // n = 4, score = 400
            //   c745d800020000       | mov                 dword ptr [ebp - 0x28], 0x200
            //   8975d4               | mov                 dword ptr [ebp - 0x2c], esi
            //   8975dc               | mov                 dword ptr [ebp - 0x24], esi
            //   8975e0               | mov                 dword ptr [ebp - 0x20], esi

        $sequence_16 = { 03c1 8b500c 8945fc 3bd3 0f8424010000 }
            // n = 5, score = 400
            //   03c1                 | add                 eax, ecx
            //   8b500c               | mov                 edx, dword ptr [eax + 0xc]
            //   8945fc               | mov                 dword ptr [ebp - 4], eax
            //   3bd3                 | cmp                 edx, ebx
            //   0f8424010000         | je                  0x12a

        $sequence_17 = { 7306 8b00 3bc1 75f3 395e14 }
            // n = 5, score = 400
            //   7306                 | jae                 8
            //   8b00                 | mov                 eax, dword ptr [eax]
            //   3bc1                 | cmp                 eax, ecx
            //   75f3                 | jne                 0xfffffff5
            //   395e14               | cmp                 dword ptr [esi + 0x14], ebx

        $sequence_18 = { ff15???????? 8b550c 884304 8bc2 }
            // n = 4, score = 400
            //   ff15????????         |                     
            //   8b550c               | mov                 edx, dword ptr [ebp + 0xc]
            //   884304               | mov                 byte ptr [ebx + 4], al
            //   8bc2                 | mov                 eax, edx

        $sequence_19 = { 8b500c 85d2 0f85effeffff eb07 c745f86f0300c0 }
            // n = 5, score = 400
            //   8b500c               | mov                 edx, dword ptr [eax + 0xc]
            //   85d2                 | test                edx, edx
            //   0f85effeffff         | jne                 0xfffffef5
            //   eb07                 | jmp                 9
            //   c745f86f0300c0       | mov                 dword ptr [ebp - 8], 0xc000036f

        $sequence_20 = { 8b4d0c 897604 8936 8d7e08 }
            // n = 4, score = 400
            //   8b4d0c               | mov                 ecx, dword ptr [ebp + 0xc]
            //   897604               | mov                 dword ptr [esi + 4], esi
            //   8936                 | mov                 dword ptr [esi], esi
            //   8d7e08               | lea                 edi, [esi + 8]

        $sequence_21 = { 8b4608 8b4e0c 8901 894804 8b4718 }
            // n = 5, score = 400
            //   8b4608               | mov                 eax, dword ptr [esi + 8]
            //   8b4e0c               | mov                 ecx, dword ptr [esi + 0xc]
            //   8901                 | mov                 dword ptr [ecx], eax
            //   894804               | mov                 dword ptr [eax + 4], ecx
            //   8b4718               | mov                 eax, dword ptr [edi + 0x18]

        $sequence_22 = { 23db 81e1ff000000 23c9 83440c0404 }
            // n = 4, score = 200
            //   23db                 | and                 ebx, ebx
            //   81e1ff000000         | and                 ecx, 0xff
            //   23c9                 | and                 ecx, ecx
            //   83440c0404           | add                 dword ptr [esp + ecx + 4], 4

        $sequence_23 = { 23c0 8be5 5d c20800 }
            // n = 4, score = 200
            //   23c0                 | and                 eax, eax
            //   8be5                 | mov                 esp, ebp
            //   5d                   | pop                 ebp
            //   c20800               | ret                 8

        $sequence_24 = { 55 8bec 85db 85c9 }
            // n = 4, score = 200
            //   55                   | push                ebp
            //   8bec                 | mov                 ebp, esp
            //   85db                 | test                ebx, ebx
            //   85c9                 | test                ecx, ecx

        $sequence_25 = { 5d c3 85c0 e8???????? }
            // n = 4, score = 200
            //   5d                   | pop                 ebp
            //   c3                   | ret                 
            //   85c0                 | test                eax, eax
            //   e8????????           |                     

        $sequence_26 = { 8be5 5d c3 85c9 e8???????? }
            // n = 5, score = 200
            //   8be5                 | mov                 esp, ebp
            //   5d                   | pop                 ebp
            //   c3                   | ret                 
            //   85c9                 | test                ecx, ecx
            //   e8????????           |                     

        $sequence_27 = { 23c9 16 85c9 23d2 }
            // n = 4, score = 200
            //   23c9                 | and                 ecx, ecx
            //   16                   | push                ss
            //   85c9                 | test                ecx, ecx
            //   23d2                 | and                 edx, edx

        $sequence_28 = { 17 48 a7 8e17 48 }
            // n = 5, score = 100
            //   17                   | pop                 ss
            //   48                   | dec                 eax
            //   a7                   | cmpsd               dword ptr [esi], dword ptr es:[edi]
            //   8e17                 | mov                 ss, word ptr [edi]
            //   48                   | dec                 eax

        $sequence_29 = { 0522840000 2daa8d0e99 837c242c00 7405 57 }
            // n = 5, score = 100
            //   0522840000           | add                 eax, 0x8422
            //   2daa8d0e99           | sub                 eax, 0x990e8daa
            //   837c242c00           | cmp                 dword ptr [esp + 0x2c], 0
            //   7405                 | je                  7
            //   57                   | push                edi

        $sequence_30 = { 3d2041d318 4b 16 d24055 2672f7 6232 }
            // n = 6, score = 100
            //   3d2041d318           | cmp                 eax, 0x18d34120
            //   4b                   | dec                 ebx
            //   16                   | push                ss
            //   d24055               | rol                 byte ptr [eax + 0x55], cl
            //   2672f7               | jb                  0xfffffffa
            //   6232                 | bound               esi, qword ptr [edx]

        $sequence_31 = { 0e 99 5c 6824cdfd55 99 }
            // n = 5, score = 100
            //   0e                   | push                cs
            //   99                   | cdq                 
            //   5c                   | pop                 esp
            //   6824cdfd55           | push                0x55fdcd24
            //   99                   | cdq                 

        $sequence_32 = { 43 55 4d 46 734c 81babc5f81ca5c1bea9b }
            // n = 6, score = 100
            //   43                   | inc                 ebx
            //   55                   | push                ebp
            //   4d                   | dec                 ebp
            //   46                   | inc                 esi
            //   734c                 | jae                 0x4e
            //   81babc5f81ca5c1bea9b     | cmp    dword ptr [edx - 0x357ea044], 0x9bea1b5c

        $sequence_33 = { 8b4d08 85d2 81e1ff000000 85db 83440c0404 23d2 8be5 }
            // n = 7, score = 100
            //   8b4d08               | mov                 ecx, dword ptr [ebp + 8]
            //   85d2                 | test                edx, edx
            //   81e1ff000000         | and                 ecx, 0xff
            //   85db                 | test                ebx, ebx
            //   83440c0404           | add                 dword ptr [esp + ecx + 4], 4
            //   23d2                 | and                 edx, edx
            //   8be5                 | mov                 esp, ebp

        $sequence_34 = { 54 136e17 48 f678e7 }
            // n = 4, score = 100
            //   54                   | push                esp
            //   136e17               | adc                 ebp, dword ptr [esi + 0x17]
            //   48                   | dec                 eax
            //   f678e7               | idiv                byte ptr [eax - 0x19]

        $sequence_35 = { 004d62 325936 216da3 184b16 }
            // n = 4, score = 100
            //   004d62               | add                 byte ptr [ebp + 0x62], cl
            //   325936               | xor                 bl, byte ptr [ecx + 0x36]
            //   216da3               | and                 dword ptr [ebp - 0x5d], ebp
            //   184b16               | sbb                 byte ptr [ebx + 0x16], cl

        $sequence_36 = { 8bec 53 98 5d 085676 57 }
            // n = 6, score = 100
            //   8bec                 | mov                 ebp, esp
            //   53                   | push                ebx
            //   98                   | cwde                
            //   5d                   | pop                 ebp
            //   085676               | or                  byte ptr [esi + 0x76], dl
            //   57                   | push                edi

        $sequence_37 = { 6d b702 2f 6e }
            // n = 4, score = 100
            //   6d                   | insd                dword ptr es:[edi], dx
            //   b702                 | mov                 bh, 2
            //   2f                   | das                 
            //   6e                   | outsb               dx, byte ptr [esi]

        $sequence_38 = { 0f84f05325b8 91 41 9a3272010f7878 739d }
            // n = 5, score = 100
            //   0f84f05325b8         | je                  0xb82553f6
            //   91                   | xchg                eax, ecx
            //   41                   | inc                 ecx
            //   9a3272010f7878       | lcall               0x7878:0xf017232
            //   739d                 | jae                 0xffffff9f

    condition:
        7 of them and filesize < 548864
}