rule win_lazardoor_auto {

    meta:
        author = "Felix Bilstein - yara-signator at cocacoding dot com"
        date = "2022-11-21"
        version = "1"
        description = "Detects win.lazardoor."
        info = "autogenerated rule brought to you by yara-signator"
        tool = "yara-signator v0.6.0"
        signator_config = "callsandjumps;datarefs;binvalue"
        malpedia_reference = "https://malpedia.caad.fkie.fraunhofer.de/details/win.lazardoor"
        malpedia_rule_date = "20221118"
        malpedia_hash = "e0702e2e6d1d00da65c8a29a4ebacd0a4c59e1af"
        malpedia_version = "20221125"
        malpedia_license = "CC BY-SA 4.0"
        malpedia_sharing = "TLP:WHITE"

    /* DISCLAIMER
     * The strings used in this rule have been automatically selected from the
     * disassembly of memory dumps and unpacked files, using YARA-Signator.
     * The code and documentation is published here:
     * https://github.com/fxb-cocacoding/yara-signator
     * As Malpedia is used as data source, please note that for a given
     * number of families, only single samples are documented.
     * This likely impacts the degree of generalization these rules will offer.
     * Take the described generation method also into consideration when you
     * apply the rules in your use cases and assign them confidence levels.
     */


    strings:
        $sequence_0 = { 85c9 7872 3b1d???????? 736a 488bc3 4c8d35fa250100 83e03f }
            // n = 7, score = 100
            //   85c9                 | je                  0x39b
            //   7872                 | dec                 eax
            //   3b1d????????         |                     
            //   736a                 | test                ecx, ecx
            //   488bc3               | je                  0x39b
            //   4c8d35fa250100       | dec                 eax
            //   83e03f               | mov                 eax, dword ptr [esi]

        $sequence_1 = { 5d c3 33c0 ebdb 4c8b742420 b801000000 4883c428 }
            // n = 7, score = 100
            //   5d                   | dec                 eax
            //   c3                   | mov                 dword ptr [esp + 0x80], edi
            //   33c0                 | test                eax, eax
            //   ebdb                 | jne                 0x4eb
            //   4c8b742420           | dec                 eax
            //   b801000000           | lea                 esi, [0x291a9]
            //   4883c428             | mov                 eax, dword ptr [esp + 0x40]

        $sequence_2 = { 0f29b42490010000 0f29bc2480010000 0f8484010000 33d2 488d442448 4c8d4c2440 4889442420 }
            // n = 7, score = 100
            //   0f29b42490010000     | dec                 ebp
            //   0f29bc2480010000     | mov                 esp, ecx
            //   0f8484010000         | dec                 eax
            //   33d2                 | sub                 esp, 0x70
            //   488d442448           | dec                 eax
            //   4c8d4c2440           | xor                 eax, esp
            //   4889442420           | dec                 eax

        $sequence_3 = { 488d1552c0feff 2b4c244c 41b826000000 894c2448 0f8542fcffff }
            // n = 5, score = 100
            //   488d1552c0feff       | mov                 eax, 0x3834
            //   2b4c244c             | xor                 edx, edx
            //   41b826000000         | dec                 eax
            //   894c2448             | lea                 ecx, [0x2557b]
            //   0f8542fcffff         | inc                 ecx

        $sequence_4 = { 4053 4883ec20 8b1d???????? eb1d 488d056b740100 ffcb 488d0c9b }
            // n = 7, score = 100
            //   4053                 | dec                 eax
            //   4883ec20             | xor                 eax, esp
            //   8b1d????????         |                     
            //   eb1d                 | dec                 eax
            //   488d056b740100       | mov                 dword ptr [esp + 0x170], eax
            //   ffcb                 | inc                 ebp
            //   488d0c9b             | xor                 ebp, ebp

        $sequence_5 = { 488bf8 498bcf 488d4590 488bd7 }
            // n = 4, score = 100
            //   488bf8               | je                  0x260
            //   498bcf               | dec                 eax
            //   488d4590             | mov                 edx, edi
            //   488bd7               | dec                 eax

        $sequence_6 = { 0fb7c0 66f3ab 488d3df44b0100 482bfe 8a041f 8803 48ffc3 }
            // n = 7, score = 100
            //   0fb7c0               | dec                 eax
            //   66f3ab               | mov                 dword ptr [ebp - 0x11], eax
            //   488d3df44b0100       | dec                 eax
            //   482bfe               | lea                 ecx, [0xfffea226]
            //   8a041f               | and                 eax, 0x3f
            //   8803                 | inc                 ebp
            //   48ffc3               | mov                 ebp, ecx

        $sequence_7 = { c60300 493bfa 7403 48ffcf 410fb6d3 4c8d0db3c90000 }
            // n = 6, score = 100
            //   c60300               | dec                 eax
            //   493bfa               | lea                 eax, [0xfffea017]
            //   7403                 | dec                 edx
            //   48ffcf               | mov                 edx, dword ptr [eax + 0x27630]
            //   410fb6d3             | inc                 edx
            //   4c8d0db3c90000       | mov                 cl, byte ptr [edx + esi*8 + 0x3d]

        $sequence_8 = { 57 4883ec20 488d05ef2c0100 488bf9 488901 8bda }
            // n = 6, score = 100
            //   57                   | je                  0x650
            //   4883ec20             | dec                 eax
            //   488d05ef2c0100       | lea                 eax, [0x10e7e]
            //   488bf9               | dec                 edx
            //   488901               | mov                 eax, dword ptr [eax + ebp*8]
            //   8bda                 | inc                 edx

        $sequence_9 = { 0f8c79ffffff 4c8b742428 4c8b6c2450 498bde 482b5d30 0f8498000000 4439b9b4000000 }
            // n = 7, score = 100
            //   0f8c79ffffff         | dec                 esp
            //   4c8b742428           | mov                 dword ptr [esp + 0x20], esi
            //   4c8b6c2450           | mov                 byte ptr [esp + 0x61], 1
            //   498bde               | dec                 esp
            //   482b5d30             | mov                 edi, dword ptr [ebp - 0x80]
            //   0f8498000000         | dec                 esp
            //   4439b9b4000000       | lea                 eax, [0xffff9215]

    condition:
        7 of them and filesize < 405504
}