rule win_retefe_auto {

    meta:
        author = "Felix Bilstein - yara-signator at cocacoding dot com"
        date = "2021-06-10"
        version = "1"
        description = "Detects win.retefe."
        info = "autogenerated rule brought to you by yara-signator"
        tool = "yara-signator v0.6.0"
        signator_config = "callsandjumps;datarefs;binvalue"
        malpedia_reference = "https://malpedia.caad.fkie.fraunhofer.de/details/win.retefe"
        malpedia_rule_date = "20210604"
        malpedia_hash = "be09d5d71e77373c0f538068be31a2ad4c69cfbd"
        malpedia_version = "20210616"
        malpedia_license = "CC BY-SA 4.0"
        malpedia_sharing = "TLP:WHITE"

    /* DISCLAIMER
     * The strings used in this rule have been automatically selected from the
     * disassembly of memory dumps and unpacked files, using YARA-Signator.
     * The code and documentation is published here:
     * https://github.com/fxb-cocacoding/yara-signator
     * As Malpedia is used as data source, please note that for a given
     * number of families, only single samples are documented.
     * This likely impacts the degree of generalization these rules will offer.
     * Take the described generation method also into consideration when you
     * apply the rules in your use cases and assign them confidence levels.
     */


    strings:
        $sequence_0 = { 6a01 ff15???????? 8bf0 85f6 7410 6a09 }
            // n = 6, score = 1200
            //   6a01                 | push                1
            //   ff15????????         |                     
            //   8bf0                 | mov                 esi, eax
            //   85f6                 | test                esi, esi
            //   7410                 | je                  0x12
            //   6a09                 | push                9

        $sequence_1 = { 51 8bf8 ffd6 85c0 }
            // n = 4, score = 1200
            //   51                   | push                ecx
            //   8bf8                 | mov                 edi, eax
            //   ffd6                 | call                esi
            //   85c0                 | test                eax, eax

        $sequence_2 = { 85f6 7410 6a09 56 ff15???????? 56 ff15???????? }
            // n = 7, score = 1200
            //   85f6                 | test                esi, esi
            //   7410                 | je                  0x12
            //   6a09                 | push                9
            //   56                   | push                esi
            //   ff15????????         |                     
            //   56                   | push                esi
            //   ff15????????         |                     

        $sequence_3 = { 68f5000000 50 ff15???????? b801000000 }
            // n = 4, score = 1200
            //   68f5000000           | push                0xf5
            //   50                   | push                eax
            //   ff15????????         |                     
            //   b801000000           | mov                 eax, 1

        $sequence_4 = { 57 e8???????? 03f8 83c408 8945fc 3bfe }
            // n = 6, score = 800
            //   57                   | push                edi
            //   e8????????           |                     
            //   03f8                 | add                 edi, eax
            //   83c408               | add                 esp, 8
            //   8945fc               | mov                 dword ptr [ebp - 4], eax
            //   3bfe                 | cmp                 edi, esi

        $sequence_5 = { e8???????? 8b4e04 8901 8b4e04 }
            // n = 4, score = 800
            //   e8????????           |                     
            //   8b4e04               | mov                 ecx, dword ptr [esi + 4]
            //   8901                 | mov                 dword ptr [ecx], eax
            //   8b4e04               | mov                 ecx, dword ptr [esi + 4]

        $sequence_6 = { 51 ffd3 b810000000 6a20 }
            // n = 4, score = 800
            //   51                   | push                ecx
            //   ffd3                 | call                ebx
            //   b810000000           | mov                 eax, 0x10
            //   6a20                 | push                0x20

        $sequence_7 = { 6a9f 6a24 6aec 6a48 }
            // n = 4, score = 800
            //   6a9f                 | push                -0x61
            //   6a24                 | push                0x24
            //   6aec                 | push                -0x14
            //   6a48                 | push                0x48

        $sequence_8 = { 6ab2 6aa3 6a1e 6a93 6a93 6a96 }
            // n = 6, score = 800
            //   6ab2                 | push                -0x4e
            //   6aa3                 | push                -0x5d
            //   6a1e                 | push                0x1e
            //   6a93                 | push                -0x6d
            //   6a93                 | push                -0x6d
            //   6a96                 | push                -0x6a

        $sequence_9 = { 6a08 e8???????? 894604 83c404 8bc6 }
            // n = 5, score = 800
            //   6a08                 | push                8
            //   e8????????           |                     
            //   894604               | mov                 dword ptr [esi + 4], eax
            //   83c404               | add                 esp, 4
            //   8bc6                 | mov                 eax, esi

        $sequence_10 = { 880c10 8b4e04 40 3b4104 }
            // n = 4, score = 800
            //   880c10               | mov                 byte ptr [eax + edx], cl
            //   8b4e04               | mov                 ecx, dword ptr [esi + 4]
            //   40                   | inc                 eax
            //   3b4104               | cmp                 eax, dword ptr [ecx + 4]

        $sequence_11 = { 50 ff15???????? 83f8ff c745fcffffffff 8b4508 0f95c3 }
            // n = 6, score = 800
            //   50                   | push                eax
            //   ff15????????         |                     
            //   83f8ff               | cmp                 eax, -1
            //   c745fcffffffff       | mov                 dword ptr [ebp - 4], 0xffffffff
            //   8b4508               | mov                 eax, dword ptr [ebp + 8]
            //   0f95c3               | setne               bl

        $sequence_12 = { 8b4e04 33c0 83c404 394104 }
            // n = 4, score = 800
            //   8b4e04               | mov                 ecx, dword ptr [esi + 4]
            //   33c0                 | xor                 eax, eax
            //   83c404               | add                 esp, 4
            //   394104               | cmp                 dword ptr [ecx + 4], eax

        $sequence_13 = { 881a 884a01 8bcb c1e910 c1eb18 884a02 33c9 }
            // n = 7, score = 100
            //   881a                 | mov                 byte ptr [edx], bl
            //   884a01               | mov                 byte ptr [edx + 1], cl
            //   8bcb                 | mov                 ecx, ebx
            //   c1e910               | shr                 ecx, 0x10
            //   c1eb18               | shr                 ebx, 0x18
            //   884a02               | mov                 byte ptr [edx + 2], cl
            //   33c9                 | xor                 ecx, ecx

        $sequence_14 = { 8b06 51 8bfc 8b30 897df0 }
            // n = 5, score = 100
            //   8b06                 | mov                 eax, dword ptr [esi]
            //   51                   | push                ecx
            //   8bfc                 | mov                 edi, esp
            //   8b30                 | mov                 esi, dword ptr [eax]
            //   897df0               | mov                 dword ptr [ebp - 0x10], edi

        $sequence_15 = { 8bc1 83d200 5f 5e }
            // n = 4, score = 100
            //   8bc1                 | mov                 eax, ecx
            //   83d200               | adc                 edx, 0
            //   5f                   | pop                 edi
            //   5e                   | pop                 esi

        $sequence_16 = { 8b7514 57 8bf9 3bc6 }
            // n = 4, score = 100
            //   8b7514               | mov                 esi, dword ptr [ebp + 0x14]
            //   57                   | push                edi
            //   8bf9                 | mov                 edi, ecx
            //   3bc6                 | cmp                 eax, esi

        $sequence_17 = { 33c0 8b0e 394104 761c 660f1f840000000000 }
            // n = 5, score = 100
            //   33c0                 | xor                 eax, eax
            //   8b0e                 | mov                 ecx, dword ptr [esi]
            //   394104               | cmp                 dword ptr [ecx + 4], eax
            //   761c                 | jbe                 0x1e
            //   660f1f840000000000     | nop    word ptr [eax + eax]

        $sequence_18 = { 837e1000 7414 8b4e10 85c9 }
            // n = 4, score = 100
            //   837e1000             | cmp                 dword ptr [esi + 0x10], 0
            //   7414                 | je                  0x16
            //   8b4e10               | mov                 ecx, dword ptr [esi + 0x10]
            //   85c9                 | test                ecx, ecx

        $sequence_19 = { 8b6c2414 33c5 03c2 c1c105 }
            // n = 4, score = 100
            //   8b6c2414             | mov                 ebp, dword ptr [esp + 0x14]
            //   33c5                 | xor                 eax, ebp
            //   03c2                 | add                 eax, edx
            //   c1c105               | rol                 ecx, 5

        $sequence_20 = { 6880000000 56 57 c6860001000001 }
            // n = 4, score = 100
            //   6880000000           | push                0x80
            //   56                   | push                esi
            //   57                   | push                edi
            //   c6860001000001       | mov                 byte ptr [esi + 0x100], 1

        $sequence_21 = { 33c0 668945e8 8b45d4 886de5 8b1485a0bf4200 }
            // n = 5, score = 100
            //   33c0                 | xor                 eax, eax
            //   668945e8             | mov                 word ptr [ebp - 0x18], ax
            //   8b45d4               | mov                 eax, dword ptr [ebp - 0x2c]
            //   886de5               | mov                 byte ptr [ebp - 0x1b], ch
            //   8b1485a0bf4200       | mov                 edx, dword ptr [eax*4 + 0x42bfa0]

        $sequence_22 = { 6bc000 c780f4b9420002000000 6a04 58 6bc000 8b0d???????? 894c05f8 }
            // n = 7, score = 100
            //   6bc000               | imul                eax, eax, 0
            //   c780f4b9420002000000     | mov    dword ptr [eax + 0x42b9f4], 2
            //   6a04                 | push                4
            //   58                   | pop                 eax
            //   6bc000               | imul                eax, eax, 0
            //   8b0d????????         |                     
            //   894c05f8             | mov                 dword ptr [ebp + eax - 8], ecx

        $sequence_23 = { 0f8474030000 83e51f 3bfd 735d }
            // n = 4, score = 100
            //   0f8474030000         | je                  0x37a
            //   83e51f               | and                 ebp, 0x1f
            //   3bfd                 | cmp                 edi, ebp
            //   735d                 | jae                 0x5f

        $sequence_24 = { 7306 6689545d00 43 83c602 }
            // n = 4, score = 100
            //   7306                 | jae                 8
            //   6689545d00           | mov                 word ptr [ebp + ebx*2], dx
            //   43                   | inc                 ebx
            //   83c602               | add                 esi, 2

        $sequence_25 = { 8a442414 83c602 0fb73e 6685ff }
            // n = 4, score = 100
            //   8a442414             | mov                 al, byte ptr [esp + 0x14]
            //   83c602               | add                 esi, 2
            //   0fb73e               | movzx               edi, word ptr [esi]
            //   6685ff               | test                di, di

        $sequence_26 = { 33c8 c1eb08 331c8d20da4200 42 89550c }
            // n = 5, score = 100
            //   33c8                 | xor                 ecx, eax
            //   c1eb08               | shr                 ebx, 8
            //   331c8d20da4200       | xor                 ebx, dword ptr [ecx*4 + 0x42da20]
            //   42                   | inc                 edx
            //   89550c               | mov                 dword ptr [ebp + 0xc], edx

        $sequence_27 = { ff15???????? 8b4b10 6a00 6a00 }
            // n = 4, score = 100
            //   ff15????????         |                     
            //   8b4b10               | mov                 ecx, dword ptr [ebx + 0x10]
            //   6a00                 | push                0
            //   6a00                 | push                0

        $sequence_28 = { 7509 b805400080 5d c21000 8910 8b410c }
            // n = 6, score = 100
            //   7509                 | jne                 0xb
            //   b805400080           | mov                 eax, 0x80004005
            //   5d                   | pop                 ebp
            //   c21000               | ret                 0x10
            //   8910                 | mov                 dword ptr [eax], edx
            //   8b410c               | mov                 eax, dword ptr [ecx + 0xc]

    condition:
        7 of them and filesize < 843776
}