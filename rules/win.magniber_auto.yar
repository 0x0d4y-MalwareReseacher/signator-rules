rule win_magniber_auto {

    meta:
        author = "Felix Bilstein - yara-signator at cocacoding dot com"
        date = "2021-06-10"
        version = "1"
        description = "Detects win.magniber."
        info = "autogenerated rule brought to you by yara-signator"
        tool = "yara-signator v0.6.0"
        signator_config = "callsandjumps;datarefs;binvalue"
        malpedia_reference = "https://malpedia.caad.fkie.fraunhofer.de/details/win.magniber"
        malpedia_rule_date = "20210604"
        malpedia_hash = "be09d5d71e77373c0f538068be31a2ad4c69cfbd"
        malpedia_version = "20210616"
        malpedia_license = "CC BY-SA 4.0"
        malpedia_sharing = "TLP:WHITE"

    /* DISCLAIMER
     * The strings used in this rule have been automatically selected from the
     * disassembly of memory dumps and unpacked files, using YARA-Signator.
     * The code and documentation is published here:
     * https://github.com/fxb-cocacoding/yara-signator
     * As Malpedia is used as data source, please note that for a given
     * number of families, only single samples are documented.
     * This likely impacts the degree of generalization these rules will offer.
     * Take the described generation method also into consideration when you
     * apply the rules in your use cases and assign them confidence levels.
     */


    strings:
        $sequence_0 = { c78544fdffffa4994000 c78548fdffffac994000 c7854cfdffffb4994000 c78550fdffffc0994000 }
            // n = 4, score = 400
            //   c78544fdffffa4994000     | mov    dword ptr [ebp - 0x2bc], 0x4099a4
            //   c78548fdffffac994000     | mov    dword ptr [ebp - 0x2b8], 0x4099ac
            //   c7854cfdffffb4994000     | mov    dword ptr [ebp - 0x2b4], 0x4099b4
            //   c78550fdffffc0994000     | mov    dword ptr [ebp - 0x2b0], 0x4099c0

        $sequence_1 = { 50 ff15???????? 8b55f4 52 ff15???????? 8b4508 50 }
            // n = 7, score = 400
            //   50                   | push                eax
            //   ff15????????         |                     
            //   8b55f4               | mov                 edx, dword ptr [ebp - 0xc]
            //   52                   | push                edx
            //   ff15????????         |                     
            //   8b4508               | mov                 eax, dword ptr [ebp + 8]
            //   50                   | push                eax

        $sequence_2 = { ba72000000 6689559a b865000000 6689459c b961000000 66894d9e ba74000000 }
            // n = 7, score = 400
            //   ba72000000           | mov                 edx, 0x72
            //   6689559a             | mov                 word ptr [ebp - 0x66], dx
            //   b865000000           | mov                 eax, 0x65
            //   6689459c             | mov                 word ptr [ebp - 0x64], ax
            //   b961000000           | mov                 ecx, 0x61
            //   66894d9e             | mov                 word ptr [ebp - 0x62], cx
            //   ba74000000           | mov                 edx, 0x74

        $sequence_3 = { 52 8b45e4 50 6a00 ff15???????? 50 }
            // n = 6, score = 400
            //   52                   | push                edx
            //   8b45e4               | mov                 eax, dword ptr [ebp - 0x1c]
            //   50                   | push                eax
            //   6a00                 | push                0
            //   ff15????????         |                     
            //   50                   | push                eax

        $sequence_4 = { c78564feffff209c4000 c78568feffff2c9c4000 c7856cfeffff349c4000 c78570feffff3c9c4000 }
            // n = 4, score = 400
            //   c78564feffff209c4000     | mov    dword ptr [ebp - 0x19c], 0x409c20
            //   c78568feffff2c9c4000     | mov    dword ptr [ebp - 0x198], 0x409c2c
            //   c7856cfeffff349c4000     | mov    dword ptr [ebp - 0x194], 0x409c34
            //   c78570feffff3c9c4000     | mov    dword ptr [ebp - 0x190], 0x409c3c

        $sequence_5 = { 52 8b45e4 50 6a00 8b4dd4 51 }
            // n = 6, score = 400
            //   52                   | push                edx
            //   8b45e4               | mov                 eax, dword ptr [ebp - 0x1c]
            //   50                   | push                eax
            //   6a00                 | push                0
            //   8b4dd4               | mov                 ecx, dword ptr [ebp - 0x2c]
            //   51                   | push                ecx

        $sequence_6 = { c78560f9ffff50914000 c78564f9ffff58914000 c78568f9ffff60914000 c7856cf9ffff68914000 c78570f9ffff70914000 c78574f9ffff78914000 }
            // n = 6, score = 400
            //   c78560f9ffff50914000     | mov    dword ptr [ebp - 0x6a0], 0x409150
            //   c78564f9ffff58914000     | mov    dword ptr [ebp - 0x69c], 0x409158
            //   c78568f9ffff60914000     | mov    dword ptr [ebp - 0x698], 0x409160
            //   c7856cf9ffff68914000     | mov    dword ptr [ebp - 0x694], 0x409168
            //   c78570f9ffff70914000     | mov    dword ptr [ebp - 0x690], 0x409170
            //   c78574f9ffff78914000     | mov    dword ptr [ebp - 0x68c], 0x409178

        $sequence_7 = { c78510fbffffdc944000 c78514fbffffe4944000 c78518fbffffec944000 c7851cfbfffff4944000 c78520fbfffffc944000 c78524fbffff04954000 }
            // n = 6, score = 400
            //   c78510fbffffdc944000     | mov    dword ptr [ebp - 0x4f0], 0x4094dc
            //   c78514fbffffe4944000     | mov    dword ptr [ebp - 0x4ec], 0x4094e4
            //   c78518fbffffec944000     | mov    dword ptr [ebp - 0x4e8], 0x4094ec
            //   c7851cfbfffff4944000     | mov    dword ptr [ebp - 0x4e4], 0x4094f4
            //   c78520fbfffffc944000     | mov    dword ptr [ebp - 0x4e0], 0x4094fc
            //   c78524fbffff04954000     | mov    dword ptr [ebp - 0x4dc], 0x409504

        $sequence_8 = { b9e8030000 f7f9 0305???????? a3???????? 8b15???????? }
            // n = 5, score = 400
            //   b9e8030000           | mov                 ecx, 0x3e8
            //   f7f9                 | idiv                ecx
            //   0305????????         |                     
            //   a3????????           |                     
            //   8b15????????         |                     

        $sequence_9 = { 837dc400 7507 33c0 e9???????? 837df800 7505 }
            // n = 6, score = 400
            //   837dc400             | cmp                 dword ptr [ebp - 0x3c], 0
            //   7507                 | jne                 9
            //   33c0                 | xor                 eax, eax
            //   e9????????           |                     
            //   837df800             | cmp                 dword ptr [ebp - 8], 0
            //   7505                 | jne                 7

    condition:
        7 of them and filesize < 114688
}