rule win_nokoyawa_auto {

    meta:
        author = "Felix Bilstein - yara-signator at cocacoding dot com"
        date = "2022-11-21"
        version = "1"
        description = "Detects win.nokoyawa."
        info = "autogenerated rule brought to you by yara-signator"
        tool = "yara-signator v0.6.0"
        signator_config = "callsandjumps;datarefs;binvalue"
        malpedia_reference = "https://malpedia.caad.fkie.fraunhofer.de/details/win.nokoyawa"
        malpedia_rule_date = "20221118"
        malpedia_hash = "e0702e2e6d1d00da65c8a29a4ebacd0a4c59e1af"
        malpedia_version = "20221125"
        malpedia_license = "CC BY-SA 4.0"
        malpedia_sharing = "TLP:WHITE"

    /* DISCLAIMER
     * The strings used in this rule have been automatically selected from the
     * disassembly of memory dumps and unpacked files, using YARA-Signator.
     * The code and documentation is published here:
     * https://github.com/fxb-cocacoding/yara-signator
     * As Malpedia is used as data source, please note that for a given
     * number of families, only single samples are documented.
     * This likely impacts the degree of generalization these rules will offer.
     * Take the described generation method also into consideration when you
     * apply the rules in your use cases and assign them confidence levels.
     */


    strings:
        $sequence_0 = { 33c0 85c0 0f8528ffffff b804000000 486bc00f b904000000 486bc901 }
            // n = 7, score = 100
            //   33c0                 | inc                 ecx
            //   85c0                 | mov                 eax, 4
            //   0f8528ffffff         | dec                 ebp
            //   b804000000           | imul                eax, eax, 5
            //   486bc00f             | dec                 esp
            //   b904000000           | mov                 ecx, dword ptr [esp + 0x50]
            //   486bc901             | dec                 ebp

        $sequence_1 = { c1e205 0bd1 8bca 8b942418010000 03d1 8bca bad6c162ca }
            // n = 7, score = 100
            //   c1e205               | jmp                 0x3a4
            //   0bd1                 | mov                 eax, dword ptr [esp + 0x20]
            //   8bca                 | inc                 eax
            //   8b942418010000       | inc                 ecx
            //   03d1                 | mov                 eax, dword ptr [eax + eax*4]
            //   8bca                 | mov                 dword ptr [edx + ecx*4], eax
            //   bad6c162ca           | mov                 eax, dword ptr [esp]

        $sequence_2 = { 0f84a4010000 488d15c0640000 488d4c245c e8???????? 85c0 0f84e1000000 }
            // n = 6, score = 100
            //   0f84a4010000         | test                eax, eax
            //   488d15c0640000       | jne                 0x19aa
            //   488d4c245c           | mov                 eax, 4
            //   e8????????           |                     
            //   85c0                 | dec                 eax
            //   0f84e1000000         | imul                eax, eax, 3

        $sequence_3 = { 486bc901 8b4c0c20 8b440420 33c1 b904000000 486bc907 }
            // n = 6, score = 100
            //   486bc901             | mov                 ecx, dword ptr [esp + 0x14]
            //   8b4c0c20             | mov                 edx, dword ptr [esp + 0x10]
            //   8b440420             | mov                 ecx, dword ptr [esp + 8]
            //   33c1                 | shr                 ecx, 0x1b
            //   b904000000           | mov                 edx, dword ptr [esp + 8]
            //   486bc907             | shl                 edx, 5

        $sequence_4 = { 48833c2400 740b 488b0424 4889442408 eb0a 488b442420 }
            // n = 6, score = 100
            //   48833c2400           | mov                 edx, dword ptr [esp + 8]
            //   740b                 | shl                 edx, 5
            //   488b0424             | or                  edx, ecx
            //   4889442408           | mov                 ecx, edx
            //   eb0a                 | mov                 edx, dword ptr [esp + 0xec]
            //   488b442420           | mov                 edx, dword ptr [esp + 0xc]

        $sequence_5 = { b804000000 486bc006 488b4c2450 4803c8 488bc1 b904000000 }
            // n = 6, score = 100
            //   b804000000           | dec                 eax
            //   486bc006             | mov                 edx, dword ptr [esp + 0x50]
            //   488b4c2450           | dec                 esp
            //   4803c8               | mov                 eax, dword ptr [esp + 0x48]
            //   488bc1               | dec                 eax
            //   b904000000           | test                eax, eax

        $sequence_6 = { e8???????? 488d4c245c e8???????? 488bd0 488d8c24a0060000 e8???????? 488b15???????? }
            // n = 7, score = 100
            //   e8????????           |                     
            //   488d4c245c           | dec                 eax
            //   e8????????           |                     
            //   488bd0               | imul                ecx, ecx, 0xc
            //   488d8c24a0060000     | xor                 eax, dword ptr [esp + ecx + 0x20]
            //   e8????????           |                     
            //   488b15????????       |                     

        $sequence_7 = { 488b4c2440 8b4910 c1e918 0bc1 488b4c2420 4883c110 }
            // n = 6, score = 100
            //   488b4c2440           | mov                 dword ptr [esp + 0x48], eax
            //   8b4910               | mov                 ecx, 0x40
            //   c1e918               | mov                 ecx, 0x20
            //   0bc1                 | div                 ecx
            //   488b4c2420           | mov                 eax, eax
            //   4883c110             | dec                 eax

        $sequence_8 = { 8b54240c 33d1 8bca 8b542408 23d1 8bca 8b542410 }
            // n = 7, score = 100
            //   8b54240c             | or                  eax, ecx
            //   33d1                 | dec                 eax
            //   8bca                 | mov                 ecx, dword ptr [esp + 0x40]
            //   8b542408             | mov                 ecx, dword ptr [ecx]
            //   23d1                 | shr                 ecx, 0x18
            //   8bca                 | or                  eax, ecx
            //   8b542410             | mov                 edx, eax

        $sequence_9 = { 0bc1 89842490000000 b804000000 486bc00a 8b8c2490000000 894c0420 }
            // n = 6, score = 100
            //   0bc1                 | jle                 0x1135
            //   89842490000000       | mov                 eax, 1
            //   b804000000           | dec                 eax
            //   486bc00a             | imul                eax, eax, 1
            //   8b8c2490000000       | dec                 eax
            //   894c0420             | mov                 ecx, dword ptr [esp + 0x18]

    condition:
        7 of them and filesize < 92160
}