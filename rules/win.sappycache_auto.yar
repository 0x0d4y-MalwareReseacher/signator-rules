rule win_sappycache_auto {

    meta:
        author = "Felix Bilstein - yara-signator at cocacoding dot com"
        date = "2021-06-10"
        version = "1"
        description = "Detects win.sappycache."
        info = "autogenerated rule brought to you by yara-signator"
        tool = "yara-signator v0.6.0"
        signator_config = "callsandjumps;datarefs;binvalue"
        malpedia_reference = "https://malpedia.caad.fkie.fraunhofer.de/details/win.sappycache"
        malpedia_rule_date = "20210604"
        malpedia_hash = "be09d5d71e77373c0f538068be31a2ad4c69cfbd"
        malpedia_version = "20210616"
        malpedia_license = "CC BY-SA 4.0"
        malpedia_sharing = "TLP:WHITE"

    /* DISCLAIMER
     * The strings used in this rule have been automatically selected from the
     * disassembly of memory dumps and unpacked files, using YARA-Signator.
     * The code and documentation is published here:
     * https://github.com/fxb-cocacoding/yara-signator
     * As Malpedia is used as data source, please note that for a given
     * number of families, only single samples are documented.
     * This likely impacts the degree of generalization these rules will offer.
     * Take the described generation method also into consideration when you
     * apply the rules in your use cases and assign them confidence levels.
     */


    strings:
        $sequence_0 = { 488d15781f0100 488d8d20120000 ff15???????? 4d8bc7 49ffc0 47382c04 75f7 }
            // n = 7, score = 200
            //   488d15781f0100       | sub                 esp, 0x28
            //   488d8d20120000       | dec                 eax
            //   ff15????????         |                     
            //   4d8bc7               | or                  dword ptr [eax], 4
            //   49ffc0               | dec                 eax
            //   47382c04             | or                  dword ptr [eax], 2
            //   75f7                 | dec                 eax

        $sequence_1 = { 488bac2498000000 4c8b742460 488b4c2450 4833cc e8???????? }
            // n = 5, score = 200
            //   488bac2498000000     | mov                 ecx, ebx
            //   4c8b742460           | inc                 ecx
            //   488b4c2450           | lea                 edx, dword ptr [ecx + 1]
            //   4833cc               | inc                 ecx
            //   e8????????           |                     

        $sequence_2 = { 458d4104 ff15???????? 4c8b442438 488d442440 488b4c2430 }
            // n = 5, score = 200
            //   458d4104             | xor                 edx, edx
            //   ff15????????         |                     
            //   4c8b442438           | dec                 eax
            //   488d442440           | lea                 ecx, dword ptr [ebp + 0x4220]
            //   488b4c2430           | inc                 ecx

        $sequence_3 = { 782e 3b0d???????? 7326 4863c9 488d1530e40000 488bc1 }
            // n = 6, score = 200
            //   782e                 | dec                 eax
            //   3b0d????????         |                     
            //   7326                 | lea                 eax, dword ptr [0x1040c]
            //   4863c9               | dec                 eax
            //   488d1530e40000       | cmp                 ecx, eax
            //   488bc1               | je                  0x81c

        $sequence_4 = { 7410 4883f9ff 7406 ff15???????? 48832300 4883c308 488d0500fb0000 }
            // n = 7, score = 200
            //   7410                 | inc                 ecx
            //   4883f9ff             | mov                 ebp, eax
            //   7406                 | dec                 esp
            //   ff15????????         |                     
            //   48832300             | lea                 ecx, dword ptr [0x6cce]
            //   4883c308             | mov                 ebx, edx
            //   488d0500fb0000       | dec                 esp

        $sequence_5 = { f04f0fb1bcf150800100 4c8b05???????? 4883cfff 418bc8 498bd0 83e13f }
            // n = 6, score = 200
            //   f04f0fb1bcf150800100     | dec    eax
            //   4c8b05????????       |                     
            //   4883cfff             | inc                 edx
            //   418bc8               | inc                 esp
            //   498bd0               | cmp                 byte ptr [ebx + edx], ch
            //   83e13f               | jne                 0x1e56

        $sequence_6 = { 33c0 b900000200 488bfb f3aa 488bcb e8???????? 498bd7 }
            // n = 7, score = 200
            //   33c0                 | dec                 eax
            //   b900000200           | lea                 edx, dword ptr [0x11eb8]
            //   488bfb               | dec                 eax
            //   f3aa                 | lea                 ecx, dword ptr [ebp + 0x1220]
            //   488bcb               | dec                 eax
            //   e8????????           |                     
            //   498bd7               | lea                 edx, dword ptr [0x11f24]

        $sequence_7 = { eb0b 488bcf ff15???????? 33c0 488bac2480000000 }
            // n = 5, score = 200
            //   eb0b                 | lea                 ecx, dword ptr [edx - 1]
            //   488bcf               | dec                 eax
            //   ff15????????         |                     
            //   33c0                 | add                 ecx, edi
            //   488bac2480000000     | dec                 eax

        $sequence_8 = { 4c8ba42440630000 85ff 0f84d1fcffff 418bfd 44896d80 498bdd }
            // n = 6, score = 200
            //   4c8ba42440630000     | mov                 esi, ecx
            //   85ff                 | dec                 esp
            //   0f84d1fcffff         | lea                 edi, dword ptr [0xffff79ee]
            //   418bfd               | dec                 ebp
            //   44896d80             | mov                 esp, ecx
            //   498bdd               | dec                 ecx

        $sequence_9 = { 6644392c50 75f6 4c8d4db0 4533c0 488d8d40020000 }
            // n = 5, score = 200
            //   6644392c50           | lea                 eax, dword ptr [0xe120]
            //   75f6                 | and                 edx, 0x3f
            //   4c8d4db0             | dec                 eax
            //   4533c0               | shl                 edx, 6
            //   488d8d40020000       | dec                 eax

    condition:
        7 of them and filesize < 262144
}