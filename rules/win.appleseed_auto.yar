rule win_appleseed_auto {

    meta:
        author = "Felix Bilstein - yara-signator at cocacoding dot com"
        date = "2023-01-25"
        version = "1"
        description = "Detects win.appleseed."
        info = "autogenerated rule brought to you by yara-signator"
        tool = "yara-signator v0.6.0"
        signator_config = "callsandjumps;datarefs;binvalue"
        malpedia_reference = "https://malpedia.caad.fkie.fraunhofer.de/details/win.appleseed"
        malpedia_rule_date = "20230124"
        malpedia_hash = "2ee0eebba83dce3d019a90519f2f972c0fcf9686"
        malpedia_version = "20230125"
        malpedia_license = "CC BY-SA 4.0"
        malpedia_sharing = "TLP:WHITE"

    /* DISCLAIMER
     * The strings used in this rule have been automatically selected from the
     * disassembly of memory dumps and unpacked files, using YARA-Signator.
     * The code and documentation is published here:
     * https://github.com/fxb-cocacoding/yara-signator
     * As Malpedia is used as data source, please note that for a given
     * number of families, only single samples are documented.
     * This likely impacts the degree of generalization these rules will offer.
     * Take the described generation method also into consideration when you
     * apply the rules in your use cases and assign them confidence levels.
     */


    strings:
        $sequence_0 = { 488d93c80f0000 488bcb e8???????? 448b8374af0100 8b9370af0100 488d0d18040200 e8???????? }
            // n = 7, score = 100
            //   488d93c80f0000       | mov                 dword ptr [eax + 0x10], edi
            //   488bcb               | dec                 eax
            //   e8????????           |                     
            //   448b8374af0100       | xor                 eax, esp
            //   8b9370af0100         | dec                 eax
            //   488d0d18040200       | mov                 dword ptr [ebp + 0x160], eax
            //   e8????????           |                     

        $sequence_1 = { 48833d????????00 0f847c180000 48c745d00f000000 48895dc8 c645b800 41b840000000 488d15041e0200 }
            // n = 7, score = 100
            //   48833d????????00     |                     
            //   0f847c180000         | mov                 edx, dword ptr [eax]
            //   48c745d00f000000     | dec                 eax
            //   48895dc8             | mov                 dword ptr [esp + 0x50], 0xf
            //   c645b800             | dec                 eax
            //   41b840000000         | mov                 dword ptr [esp + 0x48], ebx
            //   488d15041e0200       | mov                 byte ptr [esp + 0x38], bl

        $sequence_2 = { 4883610800 488d052e550100 488bd9 488901 c6411000 e8???????? }
            // n = 6, score = 100
            //   4883610800           | je                  0x2e85
            //   488d052e550100       | dec                 eax
            //   488bd9               | lea                 edx, [0x21adf]
            //   488901               | dec                 eax
            //   c6411000             | lea                 ecx, [ebp - 0x48]
            //   e8????????           |                     

        $sequence_3 = { 33f6 89742450 408875e0 33d2 }
            // n = 4, score = 100
            //   33f6                 | mov                 byte ptr [ebp - 0x30], ch
            //   89742450             | xor                 eax, eax
            //   408875e0             | mov                 word ptr [ebp - 0x2f], ax
            //   33d2                 | ja                  0x577

        $sequence_4 = { 4155 4156 4157 488d6c24d9 4881eca0000000 48c745e7feffffff 48899c24f8000000 }
            // n = 7, score = 100
            //   4155                 | mov                 edx, dword ptr [eax]
            //   4156                 | dec                 eax
            //   4157                 | mov                 dword ptr [ebp + 0x70], 0xf
            //   488d6c24d9           | xor                 esi, esi
            //   4881eca0000000       | dec                 eax
            //   48c745e7feffffff     | mov                 dword ptr [ebp - 0x70], eax
            //   48899c24f8000000     | dec                 eax

        $sequence_5 = { e8???????? 48c785b00000000f000000 4889bda8000000 c6859800000000 }
            // n = 4, score = 100
            //   e8????????           |                     
            //   48c785b00000000f000000     | mov    dword ptr [ebp - 0x28], 0xfffffffe
            //   4889bda8000000       | dec                 eax
            //   c6859800000000       | mov                 dword ptr [eax + 0x10], ebx

        $sequence_6 = { 488945b0 c745a018000000 48895da8 c745b001000000 41b900000040 4c8d45a0 488d542478 }
            // n = 7, score = 100
            //   488945b0             | xor                 eax, eax
            //   c745a018000000       | dec                 eax
            //   48895da8             | mov                 ecx, eax
            //   c745b001000000       | mov                 edi, 1
            //   41b900000040         | dec                 eax
            //   4c8d45a0             | cmp                 dword ptr [ebx + 0x18], 0x10
            //   488d542478           | jb                  0xffd

        $sequence_7 = { 488b8ba0000000 488d0543fa0000 483bc8 7405 e8???????? bf0d000000 }
            // n = 6, score = 100
            //   488b8ba0000000       | dec                 eax
            //   488d0543fa0000       | lea                 ecx, [ecx + eax*2]
            //   483bc8               | dec                 ecx
            //   7405                 | mov                 ecx, esi
            //   e8????????           |                     
            //   bf0d000000           | xor                 edx, edx

        $sequence_8 = { 488bce e8???????? 488b0e e8???????? 488bc7 488b4df0 4833cc }
            // n = 7, score = 100
            //   488bce               | dec                 eax
            //   e8????????           |                     
            //   488b0e               | lea                 ecx, [ebp + 0x148]
            //   e8????????           |                     
            //   488bc7               | nop                 
            //   488b4df0             | dec                 eax
            //   4833cc               | lea                 edx, [ebp + 0x70]

        $sequence_9 = { 4c8d056c7c0100 488bc5 49f7e9 48c1fa0d 488bc2 48c1e83f 4803d0 }
            // n = 7, score = 100
            //   4c8d056c7c0100       | lea                 ecx, [ebp + 0x40]
            //   488bc5               | dec                 eax
            //   49f7e9               | cmp                 dword ptr [ebp + 0x58], 0x10
            //   48c1fa0d             | dec                 esp
            //   488bc2               | lea                 eax, [ebp - 0x60]
            //   48c1e83f             | dec                 eax
            //   4803d0               | lea                 edx, [esp + 0x78]

    condition:
        7 of them and filesize < 497664
}