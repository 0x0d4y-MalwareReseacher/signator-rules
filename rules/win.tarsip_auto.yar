rule win_tarsip_auto {

    meta:
        author = "Felix Bilstein - yara-signator at cocacoding dot com"
        date = "2022-08-05"
        version = "1"
        description = "Detects win.tarsip."
        info = "autogenerated rule brought to you by yara-signator"
        tool = "yara-signator v0.6.0"
        signator_config = "callsandjumps;datarefs;binvalue"
        malpedia_reference = "https://malpedia.caad.fkie.fraunhofer.de/details/win.tarsip"
        malpedia_rule_date = "20220805"
        malpedia_hash = "6ec06c64bcfdbeda64eff021c766b4ce34542b71"
        malpedia_version = "20220808"
        malpedia_license = "CC BY-SA 4.0"
        malpedia_sharing = "TLP:WHITE"

    /* DISCLAIMER
     * The strings used in this rule have been automatically selected from the
     * disassembly of memory dumps and unpacked files, using YARA-Signator.
     * The code and documentation is published here:
     * https://github.com/fxb-cocacoding/yara-signator
     * As Malpedia is used as data source, please note that for a given
     * number of families, only single samples are documented.
     * This likely impacts the degree of generalization these rules will offer.
     * Take the described generation method also into consideration when you
     * apply the rules in your use cases and assign them confidence levels.
     */


    strings:
        $sequence_0 = { 8d542444 52 8d742428 c68424481200000d e8???????? 8b08 }
            // n = 6, score = 100
            //   8d542444             | lea                 edx, [esp + 0x44]
            //   52                   | push                edx
            //   8d742428             | lea                 esi, [esp + 0x28]
            //   c68424481200000d     | mov                 byte ptr [esp + 0x1248], 0xd
            //   e8????????           |                     
            //   8b08                 | mov                 ecx, dword ptr [eax]

        $sequence_1 = { 7405 83c8ff eb04 8b442408 8d542408 8906 897c2408 }
            // n = 7, score = 100
            //   7405                 | je                  7
            //   83c8ff               | or                  eax, 0xffffffff
            //   eb04                 | jmp                 6
            //   8b442408             | mov                 eax, dword ptr [esp + 8]
            //   8d542408             | lea                 edx, [esp + 8]
            //   8906                 | mov                 dword ptr [esi], eax
            //   897c2408             | mov                 dword ptr [esp + 8], edi

        $sequence_2 = { b908000000 be???????? bf???????? 83eb30 f3a5 8944241c 85c0 }
            // n = 7, score = 100
            //   b908000000           | mov                 ecx, 8
            //   be????????           |                     
            //   bf????????           |                     
            //   83eb30               | sub                 ebx, 0x30
            //   f3a5                 | rep movsd           dword ptr es:[edi], dword ptr [esi]
            //   8944241c             | mov                 dword ptr [esp + 0x1c], eax
            //   85c0                 | test                eax, eax

        $sequence_3 = { c684244412000007 e8???????? 8d542450 52 8d842498000000 50 8d4c2428 }
            // n = 7, score = 100
            //   c684244412000007     | mov                 byte ptr [esp + 0x1244], 7
            //   e8????????           |                     
            //   8d542450             | lea                 edx, [esp + 0x50]
            //   52                   | push                edx
            //   8d842498000000       | lea                 eax, [esp + 0x98]
            //   50                   | push                eax
            //   8d4c2428             | lea                 ecx, [esp + 0x28]

        $sequence_4 = { 8d54245c c684248400000001 e8???????? 8b4c241c 55 }
            // n = 5, score = 100
            //   8d54245c             | lea                 edx, [esp + 0x5c]
            //   c684248400000001     | mov                 byte ptr [esp + 0x84], 1
            //   e8????????           |                     
            //   8b4c241c             | mov                 ecx, dword ptr [esp + 0x1c]
            //   55                   | push                ebp

        $sequence_5 = { 39b8a03b4200 0f8491000000 ff45e4 83c030 3df0000000 72e7 81ffe8fd0000 }
            // n = 7, score = 100
            //   39b8a03b4200         | cmp                 dword ptr [eax + 0x423ba0], edi
            //   0f8491000000         | je                  0x97
            //   ff45e4               | inc                 dword ptr [ebp - 0x1c]
            //   83c030               | add                 eax, 0x30
            //   3df0000000           | cmp                 eax, 0xf0
            //   72e7                 | jb                  0xffffffe9
            //   81ffe8fd0000         | cmp                 edi, 0xfde8

        $sequence_6 = { e9???????? 6a44 8d54244c 53 52 e8???????? }
            // n = 6, score = 100
            //   e9????????           |                     
            //   6a44                 | push                0x44
            //   8d54244c             | lea                 edx, [esp + 0x4c]
            //   53                   | push                ebx
            //   52                   | push                edx
            //   e8????????           |                     

        $sequence_7 = { 896c241c ffd7 5f b801000000 }
            // n = 4, score = 100
            //   896c241c             | mov                 dword ptr [esp + 0x1c], ebp
            //   ffd7                 | call                edi
            //   5f                   | pop                 edi
            //   b801000000           | mov                 eax, 1

        $sequence_8 = { 897c2438 896c2434 c644242400 39742454 720d 8b4c2440 51 }
            // n = 7, score = 100
            //   897c2438             | mov                 dword ptr [esp + 0x38], edi
            //   896c2434             | mov                 dword ptr [esp + 0x34], ebp
            //   c644242400           | mov                 byte ptr [esp + 0x24], 0
            //   39742454             | cmp                 dword ptr [esp + 0x54], esi
            //   720d                 | jb                  0xf
            //   8b4c2440             | mov                 ecx, dword ptr [esp + 0x40]
            //   51                   | push                ecx

        $sequence_9 = { 53 50 895c2434 895c2428 33f6 889c2498de0000 e8???????? }
            // n = 7, score = 100
            //   53                   | push                ebx
            //   50                   | push                eax
            //   895c2434             | mov                 dword ptr [esp + 0x34], ebx
            //   895c2428             | mov                 dword ptr [esp + 0x28], ebx
            //   33f6                 | xor                 esi, esi
            //   889c2498de0000       | mov                 byte ptr [esp + 0xde98], bl
            //   e8????????           |                     

    condition:
        7 of them and filesize < 360448
}