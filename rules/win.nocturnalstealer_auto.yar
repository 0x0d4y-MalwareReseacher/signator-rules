rule win_nocturnalstealer_auto {

    meta:
        author = "Felix Bilstein - yara-signator at cocacoding dot com"
        date = "2023-07-11"
        version = "1"
        description = "Detects win.nocturnalstealer."
        info = "autogenerated rule brought to you by yara-signator"
        tool = "yara-signator v0.6.0"
        signator_config = "callsandjumps;datarefs;binvalue"
        malpedia_reference = "https://malpedia.caad.fkie.fraunhofer.de/details/win.nocturnalstealer"
        malpedia_rule_date = "20230705"
        malpedia_hash = "42d0574f4405bd7d2b154d321d345acb18834a41"
        malpedia_version = "20230715"
        malpedia_license = "CC BY-SA 4.0"
        malpedia_sharing = "TLP:WHITE"

    /* DISCLAIMER
     * The strings used in this rule have been automatically selected from the
     * disassembly of memory dumps and unpacked files, using YARA-Signator.
     * The code and documentation is published here:
     * https://github.com/fxb-cocacoding/yara-signator
     * As Malpedia is used as data source, please note that for a given
     * number of families, only single samples are documented.
     * This likely impacts the degree of generalization these rules will offer.
     * Take the described generation method also into consideration when you
     * apply the rules in your use cases and assign them confidence levels.
     */


    strings:
        $sequence_0 = { f71424 c12c2408 f71424 53 bbc67fd41f 015c2404 e9???????? }
            // n = 7, score = 100
            //   f71424               | not                 dword ptr [esp]
            //   c12c2408             | shr                 dword ptr [esp], 8
            //   f71424               | not                 dword ptr [esp]
            //   53                   | push                ebx
            //   bbc67fd41f           | mov                 ebx, 0x1fd47fc6
            //   015c2404             | add                 dword ptr [esp + 4], ebx
            //   e9????????           |                     

        $sequence_1 = { c7042426c73e79 81342466052006 812c24a1217f7f 8134247ebe2ea3 890c24 89d9 50 }
            // n = 7, score = 100
            //   c7042426c73e79       | mov                 dword ptr [esp], 0x793ec726
            //   81342466052006       | xor                 dword ptr [esp], 0x6200566
            //   812c24a1217f7f       | sub                 dword ptr [esp], 0x7f7f21a1
            //   8134247ebe2ea3       | xor                 dword ptr [esp], 0xa32ebe7e
            //   890c24               | mov                 dword ptr [esp], ecx
            //   89d9                 | mov                 ecx, ebx
            //   50                   | push                eax

        $sequence_2 = { e9???????? 58 81ea04000000 e9???????? 893c24 e9???????? 89e6 }
            // n = 7, score = 100
            //   e9????????           |                     
            //   58                   | pop                 eax
            //   81ea04000000         | sub                 edx, 4
            //   e9????????           |                     
            //   893c24               | mov                 dword ptr [esp], edi
            //   e9????????           |                     
            //   89e6                 | mov                 esi, esp

        $sequence_3 = { c9 5f b0a5 e240 96 72e2 21d9 }
            // n = 7, score = 100
            //   c9                   | leave               
            //   5f                   | pop                 edi
            //   b0a5                 | mov                 al, 0xa5
            //   e240                 | loop                0x42
            //   96                   | xchg                eax, esi
            //   72e2                 | jb                  0xffffffe4
            //   21d9                 | and                 ecx, ebx

        $sequence_4 = { 89f9 01ca bf01000000 be00000000 81e704000000 81c701000000 89ef }
            // n = 7, score = 100
            //   89f9                 | mov                 ecx, edi
            //   01ca                 | add                 edx, ecx
            //   bf01000000           | mov                 edi, 1
            //   be00000000           | mov                 esi, 0
            //   81e704000000         | and                 edi, 4
            //   81c701000000         | add                 edi, 1
            //   89ef                 | mov                 edi, ebp

        $sequence_5 = { db7a4a 59 6209 d7 57 d6 ba9feeaf3a }
            // n = 7, score = 100
            //   db7a4a               | fstp                xword ptr [edx + 0x4a]
            //   59                   | pop                 ecx
            //   6209                 | bound               ecx, qword ptr [ecx]
            //   d7                   | xlatb               
            //   57                   | push                edi
            //   d6                   | salc                
            //   ba9feeaf3a           | mov                 edx, 0x3aafee9f

        $sequence_6 = { e9???????? 89d1 8b1424 81c404000000 81e900b18f6f 81e1d275de69 c1e904 }
            // n = 7, score = 100
            //   e9????????           |                     
            //   89d1                 | mov                 ecx, edx
            //   8b1424               | mov                 edx, dword ptr [esp]
            //   81c404000000         | add                 esp, 4
            //   81e900b18f6f         | sub                 ecx, 0x6f8fb100
            //   81e1d275de69         | and                 ecx, 0x69de75d2
            //   c1e904               | shr                 ecx, 4

        $sequence_7 = { c9 52 93 96 294032 23a2fa64a42c 0e }
            // n = 7, score = 100
            //   c9                   | leave               
            //   52                   | push                edx
            //   93                   | xchg                eax, ebx
            //   96                   | xchg                eax, esi
            //   294032               | sub                 dword ptr [eax + 0x32], eax
            //   23a2fa64a42c         | and                 esp, dword ptr [edx + 0x2ca464fa]
            //   0e                   | push                cs

        $sequence_8 = { 83c704 873c24 5c 56 50 52 58 }
            // n = 7, score = 100
            //   83c704               | add                 edi, 4
            //   873c24               | xchg                dword ptr [esp], edi
            //   5c                   | pop                 esp
            //   56                   | push                esi
            //   50                   | push                eax
            //   52                   | push                edx
            //   58                   | pop                 eax

        $sequence_9 = { e9???????? 81c900f1fd71 49 81f1148b064e 89cd 59 87cd }
            // n = 7, score = 100
            //   e9????????           |                     
            //   81c900f1fd71         | or                  ecx, 0x71fdf100
            //   49                   | dec                 ecx
            //   81f1148b064e         | xor                 ecx, 0x4e068b14
            //   89cd                 | mov                 ebp, ecx
            //   59                   | pop                 ecx
            //   87cd                 | xchg                ebp, ecx

    condition:
        7 of them and filesize < 10739712
}