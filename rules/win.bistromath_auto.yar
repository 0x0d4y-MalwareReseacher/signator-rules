rule win_bistromath_auto {

    meta:
        author = "Felix Bilstein - yara-signator at cocacoding dot com"
        date = "2021-06-10"
        version = "1"
        description = "Detects win.bistromath."
        info = "autogenerated rule brought to you by yara-signator"
        tool = "yara-signator v0.6.0"
        signator_config = "callsandjumps;datarefs;binvalue"
        malpedia_reference = "https://malpedia.caad.fkie.fraunhofer.de/details/win.bistromath"
        malpedia_rule_date = "20210604"
        malpedia_hash = "be09d5d71e77373c0f538068be31a2ad4c69cfbd"
        malpedia_version = "20210616"
        malpedia_license = "CC BY-SA 4.0"
        malpedia_sharing = "TLP:WHITE"

    /* DISCLAIMER
     * The strings used in this rule have been automatically selected from the
     * disassembly of memory dumps and unpacked files, using YARA-Signator.
     * The code and documentation is published here:
     * https://github.com/fxb-cocacoding/yara-signator
     * As Malpedia is used as data source, please note that for a given
     * number of families, only single samples are documented.
     * This likely impacts the degree of generalization these rules will offer.
     * Take the described generation method also into consideration when you
     * apply the rules in your use cases and assign them confidence levels.
     */


    strings:
        $sequence_0 = { eb03 8b75e8 8b4df4 8b5df8 8b45f0 8b7de0 43 }
            // n = 7, score = 400
            //   eb03                 | jmp                 5
            //   8b75e8               | mov                 esi, dword ptr [ebp - 0x18]
            //   8b4df4               | mov                 ecx, dword ptr [ebp - 0xc]
            //   8b5df8               | mov                 ebx, dword ptr [ebp - 8]
            //   8b45f0               | mov                 eax, dword ptr [ebp - 0x10]
            //   8b7de0               | mov                 edi, dword ptr [ebp - 0x20]
            //   43                   | inc                 ebx

        $sequence_1 = { eb0c fec8 884313 0fb6c0 8b7c831c 57 8bd6 }
            // n = 7, score = 400
            //   eb0c                 | jmp                 0xe
            //   fec8                 | dec                 al
            //   884313               | mov                 byte ptr [ebx + 0x13], al
            //   0fb6c0               | movzx               eax, al
            //   8b7c831c             | mov                 edi, dword ptr [ebx + eax*4 + 0x1c]
            //   57                   | push                edi
            //   8bd6                 | mov                 edx, esi

        $sequence_2 = { eb31 83f930 7c2c 0f1f4000 83f939 7f23 46 }
            // n = 7, score = 400
            //   eb31                 | jmp                 0x33
            //   83f930               | cmp                 ecx, 0x30
            //   7c2c                 | jl                  0x2e
            //   0f1f4000             | nop                 dword ptr [eax]
            //   83f939               | cmp                 ecx, 0x39
            //   7f23                 | jg                  0x25
            //   46                   | inc                 esi

        $sequence_3 = { ebb5 837b1c00 7529 83ff20 7c0f 8b4c2418 83c8ff }
            // n = 7, score = 400
            //   ebb5                 | jmp                 0xffffffb7
            //   837b1c00             | cmp                 dword ptr [ebx + 0x1c], 0
            //   7529                 | jne                 0x2b
            //   83ff20               | cmp                 edi, 0x20
            //   7c0f                 | jl                  0x11
            //   8b4c2418             | mov                 ecx, dword ptr [esp + 0x18]
            //   83c8ff               | or                  eax, 0xffffffff

        $sequence_4 = { ff750c ff7508 68???????? ff37 e8???????? 8bd8 83c418 }
            // n = 7, score = 400
            //   ff750c               | push                dword ptr [ebp + 0xc]
            //   ff7508               | push                dword ptr [ebp + 8]
            //   68????????           |                     
            //   ff37                 | push                dword ptr [edi]
            //   e8????????           |                     
            //   8bd8                 | mov                 ebx, eax
            //   83c418               | add                 esp, 0x18

        $sequence_5 = { c644880300 c744880400000000 8954880c c744881000000000 6afb ff75e0 8bd3 }
            // n = 7, score = 400
            //   c644880300           | mov                 byte ptr [eax + ecx*4 + 3], 0
            //   c744880400000000     | mov                 dword ptr [eax + ecx*4 + 4], 0
            //   8954880c             | mov                 dword ptr [eax + ecx*4 + 0xc], edx
            //   c744881000000000     | mov                 dword ptr [eax + ecx*4 + 0x10], 0
            //   6afb                 | push                -5
            //   ff75e0               | push                dword ptr [ebp - 0x20]
            //   8bd3                 | mov                 edx, ebx

        $sequence_6 = { c745f42f000000 c745d468007400 c745d874007000 c745dc73003a00 c745e02f002f00 e8???????? 83c408 }
            // n = 7, score = 400
            //   c745f42f000000       | mov                 dword ptr [ebp - 0xc], 0x2f
            //   c745d468007400       | mov                 dword ptr [ebp - 0x2c], 0x740068
            //   c745d874007000       | mov                 dword ptr [ebp - 0x28], 0x700074
            //   c745dc73003a00       | mov                 dword ptr [ebp - 0x24], 0x3a0073
            //   c745e02f002f00       | mov                 dword ptr [ebp - 0x20], 0x2f002f
            //   e8????????           |                     
            //   83c408               | add                 esp, 8

        $sequence_7 = { f6462c10 7409 33c0 5f 5e 5b 8be5 }
            // n = 7, score = 400
            //   f6462c10             | test                byte ptr [esi + 0x2c], 0x10
            //   7409                 | je                  0xb
            //   33c0                 | xor                 eax, eax
            //   5f                   | pop                 edi
            //   5e                   | pop                 esi
            //   5b                   | pop                 ebx
            //   8be5                 | mov                 esp, ebp

        $sequence_8 = { eb03 8b458c 46 83fe0d 7d3b 8bce d3c7 }
            // n = 7, score = 400
            //   eb03                 | jmp                 5
            //   8b458c               | mov                 eax, dword ptr [ebp - 0x74]
            //   46                   | inc                 esi
            //   83fe0d               | cmp                 esi, 0xd
            //   7d3b                 | jge                 0x3d
            //   8bce                 | mov                 ecx, esi
            //   d3c7                 | rol                 edi, cl

        $sequence_9 = { 8d4db8 8bf0 e8???????? 8bc6 e9???????? 8b75b8 8b7dbc }
            // n = 7, score = 400
            //   8d4db8               | lea                 ecx, dword ptr [ebp - 0x48]
            //   8bf0                 | mov                 esi, eax
            //   e8????????           |                     
            //   8bc6                 | mov                 eax, esi
            //   e9????????           |                     
            //   8b75b8               | mov                 esi, dword ptr [ebp - 0x48]
            //   8b7dbc               | mov                 edi, dword ptr [ebp - 0x44]

    condition:
        7 of them and filesize < 33816576
}