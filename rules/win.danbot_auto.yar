rule win_danbot_auto {

    meta:
        author = "Felix Bilstein - yara-signator at cocacoding dot com"
        date = "2023-07-11"
        version = "1"
        description = "Detects win.danbot."
        info = "autogenerated rule brought to you by yara-signator"
        tool = "yara-signator v0.6.0"
        signator_config = "callsandjumps;datarefs;binvalue"
        malpedia_reference = "https://malpedia.caad.fkie.fraunhofer.de/details/win.danbot"
        malpedia_rule_date = "20230705"
        malpedia_hash = "42d0574f4405bd7d2b154d321d345acb18834a41"
        malpedia_version = "20230715"
        malpedia_license = "CC BY-SA 4.0"
        malpedia_sharing = "TLP:WHITE"

    /* DISCLAIMER
     * The strings used in this rule have been automatically selected from the
     * disassembly of memory dumps and unpacked files, using YARA-Signator.
     * The code and documentation is published here:
     * https://github.com/fxb-cocacoding/yara-signator
     * As Malpedia is used as data source, please note that for a given
     * number of families, only single samples are documented.
     * This likely impacts the degree of generalization these rules will offer.
     * Take the described generation method also into consideration when you
     * apply the rules in your use cases and assign them confidence levels.
     */


    strings:
        $sequence_0 = { 492bf0 488bd6 e8???????? 896b34 ebc3 017b34 8b4334 }
            // n = 7, score = 200
            //   492bf0               | dec                 eax
            //   488bd6               | lea                 ecx, [esp + 0x170]
            //   e8????????           |                     
            //   896b34               | test                al, al
            //   ebc3                 | test                al, al
            //   017b34               | jne                 0xd12
            //   8b4334               | dec                 esp

        $sequence_1 = { e8???????? 90 4d8bc4 488bd0 488d8c24c8010000 e8???????? 90 }
            // n = 7, score = 200
            //   e8????????           |                     
            //   90                   | xor                 edx, edx
            //   4d8bc4               | dec                 esp
            //   488bd0               | mov                 edx, dword ptr [ebp - 0x20]
            //   488d8c24c8010000     | inc                 esp
            //   e8????????           |                     
            //   90                   | mov                 esi, edx

        $sequence_2 = { 48ffc2 4d8bc7 488b4d18 e8???????? 48897d28 48897530 40887d18 }
            // n = 7, score = 200
            //   48ffc2               | mov                 bh, bl
            //   4d8bc7               | dec                 eax
            //   488b4d18             | mov                 edx, dword ptr [esp + 0x1b0]
            //   e8????????           |                     
            //   48897d28             | dec                 eax
            //   48897530             | cmp                 edx, 8
            //   40887d18             | cmp                 eax, -1

        $sequence_3 = { 48c1e702 4881ff00100000 721c 488d4f27 483bcf 7643 e8???????? }
            // n = 7, score = 200
            //   48c1e702             | lea                 ecx, [esp + 0x120]
            //   4881ff00100000       | nop                 
            //   721c                 | jne                 0x1571
            //   488d4f27             | dec                 ebp
            //   483bcf               | mov                 eax, ebp
            //   7643                 | dec                 ecx
            //   e8????????           |                     

        $sequence_4 = { e8???????? 0f10442440 0f1107 0f104c2450 0f114f10 e9???????? 488b8c2400010000 }
            // n = 7, score = 200
            //   e8????????           |                     
            //   0f10442440           | test                ecx, ecx
            //   0f1107               | je                  0x1f4
            //   0f104c2450           | mov                 eax, dword ptr [ebx + 0x84]
            //   0f114f10             | cmp                 dword ptr [esp + 0x90], eax
            //   e9????????           |                     
            //   488b8c2400010000     | jne                 0x409

        $sequence_5 = { 48ffc2 4d8bc6 488b4de0 e8???????? 4885db 0f8446fbffff 488d55e0 }
            // n = 7, score = 200
            //   48ffc2               | sub                 ecx, 1
            //   4d8bc6               | je                  0x8ff
            //   488b4de0             | sub                 ecx, 1
            //   e8????????           |                     
            //   4885db               | je                  0xb17
            //   0f8446fbffff         | sub                 ecx, 1
            //   488d55e0             | je                  0x515

        $sequence_6 = { 488d4df7 e8???????? 488d55f7 488bcb e8???????? 90 }
            // n = 6, score = 200
            //   488d4df7             | mov                 dword ptr [ebx + 0x10], edi
            //   e8????????           |                     
            //   488d55f7             | dec                 esp
            //   488bcb               | mov                 dword ptr [ebx + 0x18], esi
            //   e8????????           |                     
            //   90                   | inc                 eax

        $sequence_7 = { 4885c9 0f84d3090000 488b5928 4885db 0f84c6090000 83fa05 0f87bd090000 }
            // n = 7, score = 200
            //   4885c9               | dec                 eax
            //   0f84d3090000         | lea                 ecx, [esp + 0x120]
            //   488b5928             | dec                 eax
            //   4885db               | lea                 ecx, [esp + 0x120]
            //   0f84c6090000         | nop                 
            //   83fa05               | dec                 esp
            //   0f87bd090000         | mov                 eax, ebx

        $sequence_8 = { e8???????? 4885db 0f8446fbffff 488d55e0 488bce e8???????? 488b5810 }
            // n = 7, score = 200
            //   e8????????           |                     
            //   4885db               | inc                 eax
            //   0f8446fbffff         | sub                 dh, 0x2b
            //   488d55e0             | inc                 eax
            //   488bce               | test                dh, 0xfb
            //   e8????????           |                     
            //   488b5810             | jne                 0x649

        $sequence_9 = { 488bcf e8???????? 48894320 4885c0 7467 4c8bce }
            // n = 6, score = 200
            //   488bcf               | dec                 eax
            //   e8????????           |                     
            //   48894320             | inc                 edx
            //   4885c0               | mov                 byte ptr [esp + 0x248], bl
            //   7467                 | dec                 eax
            //   4c8bce               | mov                 edx, dword ptr [esp + 0x280]

    condition:
        7 of them and filesize < 1492992
}