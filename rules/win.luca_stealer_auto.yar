rule win_luca_stealer_auto {

    meta:
        author = "Felix Bilstein - yara-signator at cocacoding dot com"
        date = "2023-07-11"
        version = "1"
        description = "Detects win.luca_stealer."
        info = "autogenerated rule brought to you by yara-signator"
        tool = "yara-signator v0.6.0"
        signator_config = "callsandjumps;datarefs;binvalue"
        malpedia_reference = "https://malpedia.caad.fkie.fraunhofer.de/details/win.luca_stealer"
        malpedia_rule_date = "20230705"
        malpedia_hash = "42d0574f4405bd7d2b154d321d345acb18834a41"
        malpedia_version = "20230715"
        malpedia_license = "CC BY-SA 4.0"
        malpedia_sharing = "TLP:WHITE"

    /* DISCLAIMER
     * The strings used in this rule have been automatically selected from the
     * disassembly of memory dumps and unpacked files, using YARA-Signator.
     * The code and documentation is published here:
     * https://github.com/fxb-cocacoding/yara-signator
     * As Malpedia is used as data source, please note that for a given
     * number of families, only single samples are documented.
     * This likely impacts the degree of generalization these rules will offer.
     * Take the described generation method also into consideration when you
     * apply the rules in your use cases and assign them confidence levels.
     */


    strings:
        $sequence_0 = { eb37 4889f1 4889fa ff5330 4983242400 49897c2408 eb22 }
            // n = 7, score = 100
            //   eb37                 | dec                 eax
            //   4889f1               | lea                 esi, [esp + 0x540]
            //   4889fa               | dec                 eax
            //   ff5330               | mov                 ecx, esi
            //   4983242400           | movaps              xmm0, xmmword ptr [esi]
            //   49897c2408           | movaps              xmmword ptr [esp + 0x170], xmm0
            //   eb22                 | dec                 eax

        $sequence_1 = { e9???????? c3 488b01 f048ff4868 750c 488b09 4883c110 }
            // n = 7, score = 100
            //   e9????????           |                     
            //   c3                   | shr                 esi, 0x1f
            //   488b01               | test                edi, edi
            //   f048ff4868           | dec                 eax
            //   750c                 | lea                 eax, [0x35946d]
            //   488b09               | dec                 eax
            //   4883c110             | lea                 ebx, [0x38b815]

        $sequence_2 = { eb09 8b542440 4c8b542450 41bc01000000 4c396508 7554 498b4618 }
            // n = 7, score = 100
            //   eb09                 | mov                 ecx, dword ptr [edi + 0x40]
            //   8b542440             | dec                 esp
            //   4c8b542450           | mov                 eax, ebp
            //   41bc01000000         | mov                 edx, 1
            //   4c396508             | dec                 ecx
            //   7554                 | mov                 ecx, esi
            //   498b4618             | call                eax

        $sequence_3 = { e9???????? 56 4883ec20 4889ce 0fb68188000000 85c0 7418 }
            // n = 7, score = 100
            //   e9????????           |                     
            //   56                   | mov                 esi, 1
            //   4883ec20             | dec                 eax
            //   4889ce               | mov                 ebp, dword ptr [esp + 0x30]
            //   0fb68188000000       | dec                 eax
            //   85c0                 | mov                 eax, dword ptr [edi]
            //   7418                 | dec                 eax

        $sequence_4 = { ebe9 c6410100 ebe1 4157 4156 4155 4154 }
            // n = 7, score = 100
            //   ebe9                 | dec                 esp
            //   c6410100             | mov                 dword ptr [ebx + 0x2d0], esi
            //   ebe1                 | dec                 esp
            //   4157                 | mov                 dword ptr [ebx + 0x2d8], esi
            //   4156                 | dec                 eax
            //   4155                 | mov                 eax, dword ptr [esi + 0xd18]
            //   4154                 | dec                 eax

        $sequence_5 = { ff4024 488b0b 397924 7506 ff4128 488b0b 397920 }
            // n = 7, score = 100
            //   ff4024               | mov                 edi, ecx
            //   488b0b               | dec                 eax
            //   397924               | mov                 ecx, dword ptr [esp + 0x20]
            //   7506                 | dec                 eax
            //   ff4128               | mov                 edx, dword ptr [esp + 0x28]
            //   488b0b               | dec                 eax
            //   397920               | mov                 esi, dword ptr [esp + 0x30]

        $sequence_6 = { f348a5 488d742458 4889f1 4c89f2 e8???????? 410f297610 410f293e }
            // n = 7, score = 100
            //   f348a5               | and                 edi, 0x1f
            //   488d742458           | dec                 esp
            //   4889f1               | mov                 dword ptr [esi + 0x18], edi
            //   4c89f2               | dec                 esp
            //   e8????????           |                     
            //   410f297610           | add                 ebp, esi
            //   410f293e             | dec                 eax

        $sequence_7 = { f6818c00000010 7419 488d155b012600 488bcf e8???????? b81a000000 e9???????? }
            // n = 7, score = 100
            //   f6818c00000010       | dec                 eax
            //   7419                 | mov                 edi, eax
            //   488d155b012600       | dec                 eax
            //   488bcf               | mov                 ebp, eax
            //   e8????????           |                     
            //   b81a000000           | dec                 eax
            //   e9????????           |                     

        $sequence_8 = { ff542430 488b9c24c0000000 4881c480000000 415f 415e 415d 415c }
            // n = 7, score = 100
            //   ff542430             | inc                 ecx
            //   488b9c24c0000000     | pop                 edi
            //   4881c480000000       | dec                 eax
            //   415f                 | mov                 ebx, dword ptr [esp + 0x40]
            //   415e                 | lea                 ebp, [edi + 7]
            //   415d                 | dec                 eax
            //   415c                 | mov                 dword ptr [eax], esi

        $sequence_9 = { e9???????? 90 4883c428 c3 56 57 4883ec28 }
            // n = 7, score = 100
            //   e9????????           |                     
            //   90                   | sub                 al, 0x40
            //   4883c428             | inc                 ecx
            //   c3                   | add                 al, 0x80
            //   56                   | shr                 eax, 6
            //   57                   | inc                 ecx
            //   4883ec28             | cmp                 eax, 0x800

    condition:
        7 of them and filesize < 9285632
}