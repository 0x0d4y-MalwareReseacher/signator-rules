rule win_hi_zor_rat_auto {

    meta:
        author = "Felix Bilstein - yara-signator at cocacoding dot com"
        date = "2022-11-21"
        version = "1"
        description = "Detects win.hi_zor_rat."
        info = "autogenerated rule brought to you by yara-signator"
        tool = "yara-signator v0.6.0"
        signator_config = "callsandjumps;datarefs;binvalue"
        malpedia_reference = "https://malpedia.caad.fkie.fraunhofer.de/details/win.hi_zor_rat"
        malpedia_rule_date = "20221118"
        malpedia_hash = "e0702e2e6d1d00da65c8a29a4ebacd0a4c59e1af"
        malpedia_version = "20221125"
        malpedia_license = "CC BY-SA 4.0"
        malpedia_sharing = "TLP:WHITE"

    /* DISCLAIMER
     * The strings used in this rule have been automatically selected from the
     * disassembly of memory dumps and unpacked files, using YARA-Signator.
     * The code and documentation is published here:
     * https://github.com/fxb-cocacoding/yara-signator
     * As Malpedia is used as data source, please note that for a given
     * number of families, only single samples are documented.
     * This likely impacts the degree of generalization these rules will offer.
     * Take the described generation method also into consideration when you
     * apply the rules in your use cases and assign them confidence levels.
     */


    strings:
        $sequence_0 = { c7458c00003300 c7459024002500 c745943f003900 c7459838000a00 c7459c04002300 }
            // n = 5, score = 200
            //   c7458c00003300       | mov                 dword ptr [ebp - 0x74], 0x330000
            //   c7459024002500       | mov                 dword ptr [ebp - 0x70], 0x250024
            //   c745943f003900       | mov                 dword ptr [ebp - 0x6c], 0x39003f
            //   c7459838000a00       | mov                 dword ptr [ebp - 0x68], 0xa0038
            //   c7459c04002300       | mov                 dword ptr [ebp - 0x64], 0x230004

        $sequence_1 = { 235818 c1ee14 0bda 8b501c 03df 8d94132ac60700 }
            // n = 6, score = 200
            //   235818               | and                 ebx, dword ptr [eax + 0x18]
            //   c1ee14               | shr                 esi, 0x14
            //   0bda                 | or                  ebx, edx
            //   8b501c               | mov                 edx, dword ptr [eax + 0x1c]
            //   03df                 | add                 ebx, edi
            //   8d94132ac60700       | lea                 edx, [ebx + edx + 0x7c62a]

        $sequence_2 = { c744242410000000 89442420 66898c2494080000 e8???????? }
            // n = 4, score = 200
            //   c744242410000000     | mov                 dword ptr [esp + 0x24], 0x10
            //   89442420             | mov                 dword ptr [esp + 0x20], eax
            //   66898c2494080000     | mov                 word ptr [esp + 0x894], cx
            //   e8????????           |                     

        $sequence_3 = { c745d423003d00 c745d824002d00 c745dc61006400 c745e066006800 c745e42d004a00 c745e868006e00 c745ec66006200 }
            // n = 7, score = 200
            //   c745d423003d00       | mov                 dword ptr [ebp - 0x2c], 0x3d0023
            //   c745d824002d00       | mov                 dword ptr [ebp - 0x28], 0x2d0024
            //   c745dc61006400       | mov                 dword ptr [ebp - 0x24], 0x640061
            //   c745e066006800       | mov                 dword ptr [ebp - 0x20], 0x680066
            //   c745e42d004a00       | mov                 dword ptr [ebp - 0x1c], 0x4a002d
            //   c745e868006e00       | mov                 dword ptr [ebp - 0x18], 0x6e0068
            //   c745ec66006200       | mov                 dword ptr [ebp - 0x14], 0x620066

        $sequence_4 = { 8b5d08 83c424 893e eb3d 8b45fc 40 8945fc }
            // n = 7, score = 200
            //   8b5d08               | mov                 ebx, dword ptr [ebp + 8]
            //   83c424               | add                 esp, 0x24
            //   893e                 | mov                 dword ptr [esi], edi
            //   eb3d                 | jmp                 0x3f
            //   8b45fc               | mov                 eax, dword ptr [ebp - 4]
            //   40                   | inc                 eax
            //   8945fc               | mov                 dword ptr [ebp - 4], eax

        $sequence_5 = { d1f8 8bf8 8d4c3f04 51 52 8d941d94f3ffff 52 }
            // n = 7, score = 200
            //   d1f8                 | sar                 eax, 1
            //   8bf8                 | mov                 edi, eax
            //   8d4c3f04             | lea                 ecx, [edi + edi + 4]
            //   51                   | push                ecx
            //   52                   | push                edx
            //   8d941d94f3ffff       | lea                 edx, [ebp + ebx - 0xc6c]
            //   52                   | push                edx

        $sequence_6 = { 8db41e604b0000 c1e610 c1ef10 0bfe }
            // n = 4, score = 200
            //   8db41e604b0000       | lea                 esi, [esi + ebx + 0x4b60]
            //   c1e610               | shl                 esi, 0x10
            //   c1ef10               | shr                 edi, 0x10
            //   0bfe                 | or                  edi, esi

        $sequence_7 = { 3bc7 72f8 57 56 8d4df0 8bc3 }
            // n = 6, score = 200
            //   3bc7                 | cmp                 eax, edi
            //   72f8                 | jb                  0xfffffffa
            //   57                   | push                edi
            //   56                   | push                esi
            //   8d4df0               | lea                 ecx, [ebp - 0x10]
            //   8bc3                 | mov                 eax, ebx

        $sequence_8 = { 8d4de4 8bc3 e8???????? e9???????? 3d00b00000 0f85aa010000 8b5508 }
            // n = 7, score = 200
            //   8d4de4               | lea                 ecx, [ebp - 0x1c]
            //   8bc3                 | mov                 eax, ebx
            //   e8????????           |                     
            //   e9????????           |                     
            //   3d00b00000           | cmp                 eax, 0xb000
            //   0f85aa010000         | jne                 0x1b0
            //   8b5508               | mov                 edx, dword ptr [ebp + 8]

        $sequence_9 = { 66833e00 0f85cffeffff 8b4d08 8d55f4 52 8d8594f3ffff 50 }
            // n = 7, score = 200
            //   66833e00             | cmp                 word ptr [esi], 0
            //   0f85cffeffff         | jne                 0xfffffed5
            //   8b4d08               | mov                 ecx, dword ptr [ebp + 8]
            //   8d55f4               | lea                 edx, [ebp - 0xc]
            //   52                   | push                edx
            //   8d8594f3ffff         | lea                 eax, [ebp - 0xc6c]
            //   50                   | push                eax

    condition:
        7 of them and filesize < 73728
}