rule win_madmax_auto {

    meta:
        author = "Felix Bilstein - yara-signator at cocacoding dot com"
        date = "2022-08-05"
        version = "1"
        description = "Detects win.madmax."
        info = "autogenerated rule brought to you by yara-signator"
        tool = "yara-signator v0.6.0"
        signator_config = "callsandjumps;datarefs;binvalue"
        malpedia_reference = "https://malpedia.caad.fkie.fraunhofer.de/details/win.madmax"
        malpedia_rule_date = "20220805"
        malpedia_hash = "6ec06c64bcfdbeda64eff021c766b4ce34542b71"
        malpedia_version = "20220808"
        malpedia_license = "CC BY-SA 4.0"
        malpedia_sharing = "TLP:WHITE"

    /* DISCLAIMER
     * The strings used in this rule have been automatically selected from the
     * disassembly of memory dumps and unpacked files, using YARA-Signator.
     * The code and documentation is published here:
     * https://github.com/fxb-cocacoding/yara-signator
     * As Malpedia is used as data source, please note that for a given
     * number of families, only single samples are documented.
     * This likely impacts the degree of generalization these rules will offer.
     * Take the described generation method also into consideration when you
     * apply the rules in your use cases and assign them confidence levels.
     */


    strings:
        $sequence_0 = { c9 96 6858a8bc25 235580 ed 96 3a995eb00a43 }
            // n = 7, score = 100
            //   c9                   | leave               
            //   96                   | xchg                eax, esi
            //   6858a8bc25           | push                0x25bca858
            //   235580               | and                 edx, dword ptr [ebp - 0x80]
            //   ed                   | in                  eax, dx
            //   96                   | xchg                eax, esi
            //   3a995eb00a43         | cmp                 bl, byte ptr [ecx + 0x430ab05e]

        $sequence_1 = { e8???????? 84c0 9c f605????????8b 7556 013c62 c5492a }
            // n = 7, score = 100
            //   e8????????           |                     
            //   84c0                 | test                al, al
            //   9c                   | pushfd              
            //   f605????????8b       |                     
            //   7556                 | jne                 0x58
            //   013c62               | add                 dword ptr [edx], edi
            //   c5492a               | lds                 ecx, ptr [ecx + 0x2a]

        $sequence_2 = { ffb5bcfdffff 8d8437bd040000 50 9c f605????????b1 0f8511010000 7d3e }
            // n = 7, score = 100
            //   ffb5bcfdffff         | push                dword ptr [ebp - 0x244]
            //   8d8437bd040000       | lea                 eax, [edi + esi + 0x4bd]
            //   50                   | push                eax
            //   9c                   | pushfd              
            //   f605????????b1       |                     
            //   0f8511010000         | jne                 0x117
            //   7d3e                 | jge                 0x40

        $sequence_3 = { d7 94 59 0e 23fd ee dd8ae47a5510 }
            // n = 7, score = 100
            //   d7                   | xlatb               
            //   94                   | xchg                eax, esp
            //   59                   | pop                 ecx
            //   0e                   | push                cs
            //   23fd                 | and                 edi, ebp
            //   ee                   | out                 dx, al
            //   dd8ae47a5510         | fisttp              qword ptr [edx + 0x10557ae4]

        $sequence_4 = { fb 4e 1de590cfe8 2465 ba5240552e 7762 d36f3f }
            // n = 7, score = 100
            //   fb                   | sti                 
            //   4e                   | dec                 esi
            //   1de590cfe8           | sbb                 eax, 0xe8cf90e5
            //   2465                 | and                 al, 0x65
            //   ba5240552e           | mov                 edx, 0x2e554052
            //   7762                 | ja                  0x64
            //   d36f3f               | shr                 dword ptr [edi + 0x3f], cl

        $sequence_5 = { b6fa 7562 124693 92 1325???????? 15214c7bc4 4c }
            // n = 7, score = 100
            //   b6fa                 | mov                 dh, 0xfa
            //   7562                 | jne                 0x64
            //   124693               | adc                 al, byte ptr [esi - 0x6d]
            //   92                   | xchg                eax, edx
            //   1325????????         |                     
            //   15214c7bc4           | adc                 eax, 0xc47b4c21
            //   4c                   | dec                 esp

        $sequence_6 = { c74435e0e6b2b75f 5f 7161 97 bd83279044 5a e233 }
            // n = 7, score = 100
            //   c74435e0e6b2b75f     | mov                 dword ptr [ebp + esi - 0x20], 0x5fb7b2e6
            //   5f                   | pop                 edi
            //   7161                 | jno                 0x63
            //   97                   | xchg                eax, edi
            //   bd83279044           | mov                 ebp, 0x44902783
            //   5a                   | pop                 edx
            //   e233                 | loop                0x35

        $sequence_7 = { df4fa2 ffb7d9d5147d aa 0114d4 2e2e37 86c5 4e }
            // n = 7, score = 100
            //   df4fa2               | fisttp              word ptr [edi - 0x5e]
            //   ffb7d9d5147d         | push                dword ptr [edi + 0x7d14d5d9]
            //   aa                   | stosb               byte ptr es:[edi], al
            //   0114d4               | add                 dword ptr [esp + edx*8], edx
            //   2e2e37               | aaa                 
            //   86c5                 | xchg                ch, al
            //   4e                   | dec                 esi

        $sequence_8 = { e0aa 93 d541 27 de54c2f8 73df 92 }
            // n = 7, score = 100
            //   e0aa                 | loopne              0xffffffac
            //   93                   | xchg                eax, ebx
            //   d541                 | aad                 0x41
            //   27                   | daa                 
            //   de54c2f8             | ficom               word ptr [edx + eax*8 - 8]
            //   73df                 | jae                 0xffffffe1
            //   92                   | xchg                eax, edx

        $sequence_9 = { bbef9b92ca 43 5e 10b5118624e5 58 4c 58 }
            // n = 7, score = 100
            //   bbef9b92ca           | mov                 ebx, 0xca929bef
            //   43                   | inc                 ebx
            //   5e                   | pop                 esi
            //   10b5118624e5         | adc                 byte ptr [ebp - 0x1adb79ef], dh
            //   58                   | pop                 eax
            //   4c                   | dec                 esp
            //   58                   | pop                 eax

    condition:
        7 of them and filesize < 3227648
}