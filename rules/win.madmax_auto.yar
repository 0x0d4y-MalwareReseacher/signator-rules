rule win_madmax_auto {

    meta:
        author = "Felix Bilstein - yara-signator at cocacoding dot com"
        date = "2023-07-11"
        version = "1"
        description = "Detects win.madmax."
        info = "autogenerated rule brought to you by yara-signator"
        tool = "yara-signator v0.6.0"
        signator_config = "callsandjumps;datarefs;binvalue"
        malpedia_reference = "https://malpedia.caad.fkie.fraunhofer.de/details/win.madmax"
        malpedia_rule_date = "20230705"
        malpedia_hash = "42d0574f4405bd7d2b154d321d345acb18834a41"
        malpedia_version = "20230715"
        malpedia_license = "CC BY-SA 4.0"
        malpedia_sharing = "TLP:WHITE"

    /* DISCLAIMER
     * The strings used in this rule have been automatically selected from the
     * disassembly of memory dumps and unpacked files, using YARA-Signator.
     * The code and documentation is published here:
     * https://github.com/fxb-cocacoding/yara-signator
     * As Malpedia is used as data source, please note that for a given
     * number of families, only single samples are documented.
     * This likely impacts the degree of generalization these rules will offer.
     * Take the described generation method also into consideration when you
     * apply the rules in your use cases and assign them confidence levels.
     */


    strings:
        $sequence_0 = { a9cab420e8 59 50 35bf6428d9 a4 27 59 }
            // n = 7, score = 100
            //   a9cab420e8           | test                eax, 0xe820b4ca
            //   59                   | pop                 ecx
            //   50                   | push                eax
            //   35bf6428d9           | xor                 eax, 0xd92864bf
            //   a4                   | movsb               byte ptr es:[edi], byte ptr [esi]
            //   27                   | daa                 
            //   59                   | pop                 ecx

        $sequence_1 = { d6 cdaf 9e bb03e566be 7fff 2464 42 }
            // n = 7, score = 100
            //   d6                   | salc                
            //   cdaf                 | int                 0xaf
            //   9e                   | sahf                
            //   bb03e566be           | mov                 ebx, 0xbe66e503
            //   7fff                 | jg                  1
            //   2464                 | and                 al, 0x64
            //   42                   | inc                 edx

        $sequence_2 = { ce 3d9ddf6ea8 f231f3 289166d6a063 e566 47 06 }
            // n = 7, score = 100
            //   ce                   | into                
            //   3d9ddf6ea8           | cmp                 eax, 0xa86edf9d
            //   f231f3               | xor                 ebx, esi
            //   289166d6a063         | sub                 byte ptr [ecx + 0x63a0d666], dl
            //   e566                 | in                  eax, 0x66
            //   47                   | inc                 edi
            //   06                   | push                es

        $sequence_3 = { d49e e774 42 d3c2 1498 728d 49 }
            // n = 7, score = 100
            //   d49e                 | aam                 0x9e
            //   e774                 | out                 0x74, eax
            //   42                   | inc                 edx
            //   d3c2                 | rol                 edx, cl
            //   1498                 | adc                 al, 0x98
            //   728d                 | jb                  0xffffff8f
            //   49                   | dec                 ecx

        $sequence_4 = { f75501 96 ab 6d dc2d???????? 6c 9e }
            // n = 7, score = 100
            //   f75501               | not                 dword ptr [ebp + 1]
            //   96                   | xchg                eax, esi
            //   ab                   | stosd               dword ptr es:[edi], eax
            //   6d                   | insd                dword ptr es:[edi], dx
            //   dc2d????????         |                     
            //   6c                   | insb                byte ptr es:[edi], dx
            //   9e                   | sahf                

        $sequence_5 = { 9c f605????????0b 7435 bb2be5b7cc 3ce1 f1 c5606f }
            // n = 7, score = 100
            //   9c                   | pushfd              
            //   f605????????0b       |                     
            //   7435                 | je                  0x37
            //   bb2be5b7cc           | mov                 ebx, 0xccb7e52b
            //   3ce1                 | cmp                 al, 0xe1
            //   f1                   | int1                
            //   c5606f               | lds                 esp, ptr [eax + 0x6f]

        $sequence_6 = { d6 6212 c591e4cc35ef 0b831a7d2d49 854678 fc ec }
            // n = 7, score = 100
            //   d6                   | salc                
            //   6212                 | bound               edx, qword ptr [edx]
            //   c591e4cc35ef         | lds                 edx, ptr [ecx - 0x10ca331c]
            //   0b831a7d2d49         | or                  eax, dword ptr [ebx + 0x492d7d1a]
            //   854678               | test                dword ptr [esi + 0x78], eax
            //   fc                   | cld                 
            //   ec                   | in                  al, dx

        $sequence_7 = { e0cb dc64884a 78df 24fe b439 203a 1115???????? }
            // n = 7, score = 100
            //   e0cb                 | loopne              0xffffffcd
            //   dc64884a             | fsub                qword ptr [eax + ecx*4 + 0x4a]
            //   78df                 | js                  0xffffffe1
            //   24fe                 | and                 al, 0xfe
            //   b439                 | mov                 ah, 0x39
            //   203a                 | and                 byte ptr [edx], bh
            //   1115????????         |                     

        $sequence_8 = { da848d80816105 11a979d28c12 40 e58b 1850cd 47 0e }
            // n = 7, score = 100
            //   da848d80816105       | fiadd               dword ptr [ebp + ecx*4 + 0x5618180]
            //   11a979d28c12         | adc                 dword ptr [ecx + 0x128cd279], ebp
            //   40                   | inc                 eax
            //   e58b                 | in                  eax, 0x8b
            //   1850cd               | sbb                 byte ptr [eax - 0x33], dl
            //   47                   | inc                 edi
            //   0e                   | push                cs

        $sequence_9 = { f20a1d???????? 5b 54 2d99c7c310 c00422ec b747 b4fb }
            // n = 7, score = 100
            //   f20a1d????????       |                     
            //   5b                   | pop                 ebx
            //   54                   | push                esp
            //   2d99c7c310           | sub                 eax, 0x10c3c799
            //   c00422ec             | rol                 byte ptr [edx], 0xec
            //   b747                 | mov                 bh, 0x47
            //   b4fb                 | mov                 ah, 0xfb

    condition:
        7 of them and filesize < 3227648
}