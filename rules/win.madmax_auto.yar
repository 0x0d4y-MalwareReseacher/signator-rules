rule win_madmax_auto {

    meta:
        author = "Felix Bilstein - yara-signator at cocacoding dot com"
        date = "2022-11-21"
        version = "1"
        description = "Detects win.madmax."
        info = "autogenerated rule brought to you by yara-signator"
        tool = "yara-signator v0.6.0"
        signator_config = "callsandjumps;datarefs;binvalue"
        malpedia_reference = "https://malpedia.caad.fkie.fraunhofer.de/details/win.madmax"
        malpedia_rule_date = "20221118"
        malpedia_hash = "e0702e2e6d1d00da65c8a29a4ebacd0a4c59e1af"
        malpedia_version = "20221125"
        malpedia_license = "CC BY-SA 4.0"
        malpedia_sharing = "TLP:WHITE"

    /* DISCLAIMER
     * The strings used in this rule have been automatically selected from the
     * disassembly of memory dumps and unpacked files, using YARA-Signator.
     * The code and documentation is published here:
     * https://github.com/fxb-cocacoding/yara-signator
     * As Malpedia is used as data source, please note that for a given
     * number of families, only single samples are documented.
     * This likely impacts the degree of generalization these rules will offer.
     * Take the described generation method also into consideration when you
     * apply the rules in your use cases and assign them confidence levels.
     */


    strings:
        $sequence_0 = { e299 3f 29500a 668b31 b49f 9d 7fcb }
            // n = 7, score = 100
            //   e299                 | loop                0xffffff9b
            //   3f                   | aas                 
            //   29500a               | sub                 dword ptr [eax + 0xa], edx
            //   668b31               | mov                 si, word ptr [ecx]
            //   b49f                 | mov                 ah, 0x9f
            //   9d                   | popfd               
            //   7fcb                 | jg                  0xffffffcd

        $sequence_1 = { 6a6b 5d 2a53fd 42 45 8270aba0 196a92 }
            // n = 7, score = 100
            //   6a6b                 | push                0x6b
            //   5d                   | pop                 ebp
            //   2a53fd               | sub                 dl, byte ptr [ebx - 3]
            //   42                   | inc                 edx
            //   45                   | inc                 ebp
            //   8270aba0             | xor                 byte ptr [eax - 0x55], 0xa0
            //   196a92               | sbb                 dword ptr [edx - 0x6e], ebp

        $sequence_2 = { d1a0d8e17529 57 899fc011a56c 7287 3c1c f5 95 }
            // n = 7, score = 100
            //   d1a0d8e17529         | shl                 dword ptr [eax + 0x2975e1d8], 1
            //   57                   | push                edi
            //   899fc011a56c         | mov                 dword ptr [edi + 0x6ca511c0], ebx
            //   7287                 | jb                  0xffffff89
            //   3c1c                 | cmp                 al, 0x1c
            //   f5                   | cmc                 
            //   95                   | xchg                eax, ebp

        $sequence_3 = { d4df db830011153f b7ca 86fe 5e 253c828499 d47c }
            // n = 7, score = 100
            //   d4df                 | aam                 0xdf
            //   db830011153f         | fild                dword ptr [ebx + 0x3f151100]
            //   b7ca                 | mov                 bh, 0xca
            //   86fe                 | xchg                dh, bh
            //   5e                   | pop                 esi
            //   253c828499           | and                 eax, 0x9984823c
            //   d47c                 | aam                 0x7c

        $sequence_4 = { aa 94 b33f ac 08e1 b4c1 0a28 }
            // n = 7, score = 100
            //   aa                   | stosb               byte ptr es:[edi], al
            //   94                   | xchg                eax, esp
            //   b33f                 | mov                 bl, 0x3f
            //   ac                   | lodsb               al, byte ptr [esi]
            //   08e1                 | or                  cl, ah
            //   b4c1                 | mov                 ah, 0xc1
            //   0a28                 | or                  ch, byte ptr [eax]

        $sequence_5 = { 65de0f e8???????? ffcf b083 56 698e428db2da32ddfdab f1 }
            // n = 7, score = 100
            //   65de0f               | fimul               word ptr gs:[edi]
            //   e8????????           |                     
            //   ffcf                 | dec                 edi
            //   b083                 | mov                 al, 0x83
            //   56                   | push                esi
            //   698e428db2da32ddfdab     | imul    ecx, dword ptr [esi - 0x254d72be], 0xabfddd32
            //   f1                   | int1                

        $sequence_6 = { c1ff60 d4fe 231e 7246 e0f4 07 b292 }
            // n = 7, score = 100
            //   c1ff60               | sar                 edi, 0x60
            //   d4fe                 | aam                 0xfe
            //   231e                 | and                 ebx, dword ptr [esi]
            //   7246                 | jb                  0x48
            //   e0f4                 | loopne              0xfffffff6
            //   07                   | pop                 es
            //   b292                 | mov                 dl, 0x92

        $sequence_7 = { 69a2d8ee62251cbbf2ff 19f5 07 9e d0a7c153c8ef 9d 83660800 }
            // n = 7, score = 100
            //   69a2d8ee62251cbbf2ff     | imul    esp, dword ptr [edx + 0x2562eed8], 0xfff2bb1c
            //   19f5                 | sbb                 ebp, esi
            //   07                   | pop                 es
            //   9e                   | sahf                
            //   d0a7c153c8ef         | shl                 byte ptr [edi - 0x1037ac3f], 1
            //   9d                   | popfd               
            //   83660800             | and                 dword ptr [esi + 8], 0

        $sequence_8 = { b409 53 7cd5 090e becdbcf759 d2a15e44685c 630e }
            // n = 7, score = 100
            //   b409                 | mov                 ah, 9
            //   53                   | push                ebx
            //   7cd5                 | jl                  0xffffffd7
            //   090e                 | or                  dword ptr [esi], ecx
            //   becdbcf759           | mov                 esi, 0x59f7bccd
            //   d2a15e44685c         | shl                 byte ptr [ecx + 0x5c68445e], cl
            //   630e                 | arpl                word ptr [esi], cx

        $sequence_9 = { f605????????be 0f85ce000000 99 0ffc10 0a579e 5f 5e }
            // n = 7, score = 100
            //   f605????????be       |                     
            //   0f85ce000000         | jne                 0xd4
            //   99                   | cdq                 
            //   0ffc10               | paddb               mm2, qword ptr [eax]
            //   0a579e               | or                  dl, byte ptr [edi - 0x62]
            //   5f                   | pop                 edi
            //   5e                   | pop                 esi

    condition:
        7 of them and filesize < 3227648
}