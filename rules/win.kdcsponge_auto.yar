rule win_kdcsponge_auto {

    meta:
        author = "Felix Bilstein - yara-signator at cocacoding dot com"
        date = "2023-01-25"
        version = "1"
        description = "Detects win.kdcsponge."
        info = "autogenerated rule brought to you by yara-signator"
        tool = "yara-signator v0.6.0"
        signator_config = "callsandjumps;datarefs;binvalue"
        malpedia_reference = "https://malpedia.caad.fkie.fraunhofer.de/details/win.kdcsponge"
        malpedia_rule_date = "20230124"
        malpedia_hash = "2ee0eebba83dce3d019a90519f2f972c0fcf9686"
        malpedia_version = "20230125"
        malpedia_license = "CC BY-SA 4.0"
        malpedia_sharing = "TLP:WHITE"

    /* DISCLAIMER
     * The strings used in this rule have been automatically selected from the
     * disassembly of memory dumps and unpacked files, using YARA-Signator.
     * The code and documentation is published here:
     * https://github.com/fxb-cocacoding/yara-signator
     * As Malpedia is used as data source, please note that for a given
     * number of families, only single samples are documented.
     * This likely impacts the degree of generalization these rules will offer.
     * Take the described generation method also into consideration when you
     * apply the rules in your use cases and assign them confidence levels.
     */


    strings:
        $sequence_0 = { 0fb681ad040000 84c0 752a 4180f801 c781ca04000004000000 }
            // n = 5, score = 100
            //   0fb681ad040000       | mov                 dword ptr [ebx + 0x64], eax
            //   84c0                 | movzx               eax, byte ptr [ebx + 0x4af]
            //   752a                 | cmp                 al, 1
            //   4180f801             | jne                 0xce0
            //   c781ca04000004000000     | mov    dword ptr [ebx + 0x64], eax

        $sequence_1 = { 0f1f440000 85db 742a 488d15bd3f0200 488d4c245c ff15???????? 85c0 }
            // n = 7, score = 100
            //   0f1f440000           | dec                 eax
            //   85db                 | lea                 ecx, [ecx + 2]
            //   742a                 | test                ax, ax
            //   488d15bd3f0200       | jne                 0x332
            //   488d4c245c           | dec                 eax
            //   ff15????????         |                     
            //   85c0                 | lea                 eax, [esp + 0x60]

        $sequence_2 = { 4c8d15e3470100 6644398c2480000000 0f8464ffffff 418d5103 668913 }
            // n = 5, score = 100
            //   4c8d15e3470100       | test                ecx, ecx
            //   6644398c2480000000     | je    0x445
            //   0f8464ffffff         | dec                 eax
            //   418d5103             | mov                 eax, dword ptr [edx + 0x420]
            //   668913               | dec                 eax

        $sequence_3 = { 5b c3 488b8320040000 448b8378040000 0fb65001 c1ea06 899348040000 }
            // n = 7, score = 100
            //   5b                   | cmp                 dword ptr [ecx + 0x43c], 0x20
            //   c3                   | mov                 dword ptr [ecx + 0x60], 0x10002
            //   488b8320040000       | dec                 eax
            //   448b8378040000       | mov                 dword ptr [ecx + 0x128], 0x20000
            //   0fb65001             | dec                 eax
            //   c1ea06               | mov                 dword ptr [ecx + 0x158], 1
            //   899348040000         | dec                 eax

        $sequence_4 = { 4885c9 742c e8???????? 488b8f90000000 483b0d???????? 7417 488d05c0bb0100 }
            // n = 7, score = 100
            //   4885c9               | dec                 eax
            //   742c                 | mov                 ecx, ebx
            //   e8????????           |                     
            //   488b8f90000000       | jne                 0x134
            //   483b0d????????       |                     
            //   7417                 | dec                 eax
            //   488d05c0bb0100       | inc                 dword ptr [ecx + 0x420]

        $sequence_5 = { 48c7816001000002080000 c7813001000040000000 c3 33c0 c781a0040000ffffffff 89816c030000 8981b0020000 }
            // n = 7, score = 100
            //   48c7816001000002080000     | lea    ecx, [eax + 2]
            //   c7813001000040000000     | cmovne    ecx, eax
            //   c3                   | cmp                 edx, 8
            //   33c0                 | lea                 eax, [ecx + 1]
            //   c781a0040000ffffffff     | cmovne    eax, ecx
            //   89816c030000         | inc                 ecx
            //   8981b0020000         | cmp                 byte ptr [eax + 0x4c3], 1

        $sequence_6 = { 488b8b20040000 488d15043a0400 ff8380040000 48ffc1 ff8300040000 48898b20040000 }
            // n = 6, score = 100
            //   488b8b20040000       | lea                 ecx, [0x19188]
            //   488d15043a0400       | test                byte ptr [ecx + 0x38], 0x20
            //   ff8380040000         | je                  0x506
            //   48ffc1               | xor                 edx, edx
            //   ff8300040000         | jmp                 0x55a
            //   48898b20040000       | dec                 eax

        $sequence_7 = { 0f8363030000 4c89a42498010000 4c89ac2490010000 4c89b42488010000 4c89bc2480010000 833e00 0f84f4020000 }
            // n = 7, score = 100
            //   0f8363030000         | lea                 ecx, [esp + 0x60]
            //   4c89a42498010000     | nop                 word ptr [eax + eax]
            //   4c89ac2490010000     | dec                 eax
            //   4c89b42488010000     | lea                 ecx, [ecx + 0x80]
            //   4c89bc2480010000     | movups              xmm0, xmmword ptr [eax]
            //   833e00               | dec                 eax
            //   0f84f4020000         | lea                 eax, [eax + 0x80]

        $sequence_8 = { 4883832004000002 488d152d0b0400 488b8b20040000 ff8300040000 ff8380040000 c6830b04000002 }
            // n = 6, score = 100
            //   4883832004000002     | mov                 edx, edx
            //   488d152d0b0400       | mov                 eax, ecx
            //   488b8b20040000       | shr                 eax, 3
            //   ff8300040000         | and                 eax, 7
            //   ff8380040000         | mov                 dword ptr [ebx + 0x45c], eax
            //   c6830b04000002       | cmp                 eax, 1

        $sequence_9 = { b84d5a0000 663905817afdff 7579 486305b47afdff }
            // n = 4, score = 100
            //   b84d5a0000           | mov                 edx, dword ptr [edx + 0x46c]
            //   663905817afdff       | dec                 eax
            //   7579                 | test                edx, edx
            //   486305b47afdff       | je                  0x788

    condition:
        7 of them and filesize < 720896
}