rule win_kdcsponge_auto {

    meta:
        author = "Felix Bilstein - yara-signator at cocacoding dot com"
        date = "2022-08-05"
        version = "1"
        description = "Detects win.kdcsponge."
        info = "autogenerated rule brought to you by yara-signator"
        tool = "yara-signator v0.6.0"
        signator_config = "callsandjumps;datarefs;binvalue"
        malpedia_reference = "https://malpedia.caad.fkie.fraunhofer.de/details/win.kdcsponge"
        malpedia_rule_date = "20220805"
        malpedia_hash = "6ec06c64bcfdbeda64eff021c766b4ce34542b71"
        malpedia_version = "20220808"
        malpedia_license = "CC BY-SA 4.0"
        malpedia_sharing = "TLP:WHITE"

    /* DISCLAIMER
     * The strings used in this rule have been automatically selected from the
     * disassembly of memory dumps and unpacked files, using YARA-Signator.
     * The code and documentation is published here:
     * https://github.com/fxb-cocacoding/yara-signator
     * As Malpedia is used as data source, please note that for a given
     * number of families, only single samples are documented.
     * This likely impacts the degree of generalization these rules will offer.
     * Take the described generation method also into consideration when you
     * apply the rules in your use cases and assign them confidence levels.
     */


    strings:
        $sequence_0 = { 7526 80b9b104000001 8b8138040000 89813c040000 c6810904000008 750a }
            // n = 6, score = 100
            //   7526                 | dec                 eax
            //   80b9b104000001       | test                ecx, ecx
            //   8b8138040000         | je                  0x120b
            //   89813c040000         | inc                 eax
            //   c6810904000008       | push                ebx
            //   750a                 | dec                 eax

        $sequence_1 = { 740f 8bc2 c1e803 448d0cc508000000 eb03 448bca 8b84cb18010000 }
            // n = 7, score = 100
            //   740f                 | dec                 esp
            //   8bc2                 | mov                 eax, ebx
            //   c1e803               | mov                 edx, 0xb
            //   448d0cc508000000     | dec                 esp
            //   eb03                 | mov                 ecx, edi
            //   448bca               | dec                 eax
            //   8b84cb18010000       | lea                 ecx, [ebp + 0x30]

        $sequence_2 = { 493bc0 7cf3 4d8bce 488d4c2450 ba01000000 e8???????? }
            // n = 6, score = 100
            //   493bc0               | inc                 ecx
            //   7cf3                 | lea                 eax, [eax + 1]
            //   4d8bce               | dec                 eax
            //   488d4c2450           | arpl                ax, cx
            //   ba01000000           | dec                 esp
            //   e8????????           |                     

        $sequence_3 = { e8???????? 85c0 0f8401010000 488d051fb80100 4a8b04e8 42f644303880 0f84ea000000 }
            // n = 7, score = 100
            //   e8????????           |                     
            //   85c0                 | lea                 edx, [ecx + 0x44cb0]
            //   0f8401010000         | dec                 eax
            //   488d051fb80100       | lea                 ecx, [ebp + 0x324]
            //   4a8b04e8             | dec                 esp
            //   42f644303880         | mov                 eax, esi
            //   0f84ea000000         | dec                 eax

        $sequence_4 = { 817d0063736de0 7528 48833d????????00 741e 488d0d8c600100 e8???????? }
            // n = 6, score = 100
            //   817d0063736de0       | jl                  0x1077
            //   7528                 | inc                 ebp
            //   48833d????????00     |                     
            //   741e                 | cmp                 eax, edx
            //   488d0d8c600100       | jne                 0x10c2
            //   e8????????           |                     

        $sequence_5 = { 488b8b20040000 c783a404000000000000 c683a804000000 7508 d1a344040000 eb06 d1bb44040000 }
            // n = 7, score = 100
            //   488b8b20040000       | mov                 dword ptr [edx + 0x448], ecx
            //   c783a404000000000000     | cmp    ecx, 3
            //   c683a804000000       | jne                 0x186e
            //   7508                 | cmp                 byte ptr [edx + 0x409], 1
            //   d1a344040000         | jne                 0x1903
            //   eb06                 | mov                 eax, dword ptr [edx + 0x438]
            //   d1bb44040000         | mov                 dword ptr [edx + 0x44c], ecx

        $sequence_6 = { 0fb64101 c0e806 f6d0 2401 8883a6040000 0fb64101 c0e807 }
            // n = 7, score = 100
            //   0fb64101             | mov                 dword ptr [ebx + 0x4a9], 1
            //   c0e806               | je                  0xc51
            //   f6d0                 | cmp                 eax, 0xd0
            //   2401                 | jne                 0xc46
            //   8883a6040000         | mov                 eax, ecx
            //   0fb64101             | and                 eax, 0xf
            //   c0e807               | cmp                 al, 7

        $sequence_7 = { 80b9c304000001 7507 c681c504000001 e9???????? c7416000000800 c781400400006d000000 c781ca04000004000000 }
            // n = 7, score = 100
            //   80b9c304000001       | lea                 ecx, [ecx + 2]
            //   7507                 | test                ax, ax
            //   c681c504000001       | jne                 0x1d
            //   e9????????           |                     
            //   c7416000000800       | dec                 eax
            //   c781400400006d000000     | lea    edx, [0x25f6b]
            //   c781ca04000004000000     | dec    eax

        $sequence_8 = { 4c8bc2 c1e803 83e007 898250040000 498bd2 8bc1 498bc9 }
            // n = 7, score = 100
            //   4c8bc2               | mov                 dword ptr [ecx + 0x440], 0x6e
            //   c1e803               | mov                 dword ptr [ebx + 0x138], 1
            //   83e007               | dec                 eax
            //   898250040000         | add                 esp, 0x20
            //   498bd2               | pop                 ebx
            //   8bc1                 | ret                 
            //   498bc9               | mov                 dword ptr [ecx + 0x440], 0x6f

        $sequence_9 = { e9???????? 33d2 418bcd 448d4201 e8???????? 488b542440 4c8d1ddb420100 }
            // n = 7, score = 100
            //   e9????????           |                     
            //   33d2                 | je                  0x1489
            //   418bcd               | dec                 eax
            //   448d4201             | lea                 edx, [0xfffdee76]
            //   e8????????           |                     
            //   488b542440           | jne                 0x14b4
            //   4c8d1ddb420100       | dec                 eax

    condition:
        7 of them and filesize < 720896
}