rule win_data_exfiltrator_auto {

    meta:
        author = "Felix Bilstein - yara-signator at cocacoding dot com"
        date = "2022-11-21"
        version = "1"
        description = "Detects win.data_exfiltrator."
        info = "autogenerated rule brought to you by yara-signator"
        tool = "yara-signator v0.6.0"
        signator_config = "callsandjumps;datarefs;binvalue"
        malpedia_reference = "https://malpedia.caad.fkie.fraunhofer.de/details/win.data_exfiltrator"
        malpedia_rule_date = "20221118"
        malpedia_hash = "e0702e2e6d1d00da65c8a29a4ebacd0a4c59e1af"
        malpedia_version = "20221125"
        malpedia_license = "CC BY-SA 4.0"
        malpedia_sharing = "TLP:WHITE"

    /* DISCLAIMER
     * The strings used in this rule have been automatically selected from the
     * disassembly of memory dumps and unpacked files, using YARA-Signator.
     * The code and documentation is published here:
     * https://github.com/fxb-cocacoding/yara-signator
     * As Malpedia is used as data source, please note that for a given
     * number of families, only single samples are documented.
     * This likely impacts the degree of generalization these rules will offer.
     * Take the described generation method also into consideration when you
     * apply the rules in your use cases and assign them confidence levels.
     */


    strings:
        $sequence_0 = { 4c8b442440 8a0401 41880410 b804000000 486bc002 8b440410 }
            // n = 6, score = 100
            //   4c8b442440           | mov                 byte ptr [esp + 0xd3], 0x70
            //   8a0401               | mov                 byte ptr [esp + 0xd4], 0x7e
            //   41880410             | mov                 byte ptr [esp + 0xd0], 0xfb
            //   b804000000           | mov                 byte ptr [esp + 0xd1], 0xfc
            //   486bc002             | mov                 byte ptr [esp + 0xd2], 0xfe
            //   8b440410             | mov                 byte ptr [esp + 0xd3], 0xff

        $sequence_1 = { e8???????? 488d542450 488b4c2430 e8???????? 488905???????? b801000000 }
            // n = 6, score = 100
            //   e8????????           |                     
            //   488d542450           | mov                 eax, dword ptr [esp + 0x30]
            //   488b4c2430           | dec                 eax
            //   e8????????           |                     
            //   488905????????       |                     
            //   b801000000           | mov                 ecx, dword ptr [esp + 0x138]

        $sequence_2 = { c6442421fc c6442422fe c6442423ff c6442424aa c64424254f }
            // n = 5, score = 100
            //   c6442421fc           | dec                 eax
            //   c6442422fe           | mov                 eax, dword ptr [ecx + eax*8]
            //   c6442423ff           | dec                 eax
            //   c6442424aa           | mov                 ecx, dword ptr [esp + 0x28]
            //   c64424254f           | dec                 eax

        $sequence_3 = { 488b4c2450 ff15???????? 85c0 7512 488b442448 8b00 03442440 }
            // n = 7, score = 100
            //   488b4c2450           | mov                 eax, dword ptr [esp + 0x38]
            //   ff15????????         |                     
            //   85c0                 | dec                 eax
            //   7512                 | mov                 edx, eax
            //   488b442448           | dec                 eax
            //   8b00                 | mov                 ecx, dword ptr [esp + 0x60]
            //   03442440             | mov                 byte ptr [esp + 0x2c], al

        $sequence_4 = { 488d0593400000 4889442468 48c744247007000000 48c744243801000000 48c744244807000000 48c744244001000000 488d056b400000 }
            // n = 7, score = 100
            //   488d0593400000       | jbe                 0xc80
            //   4889442468           | mov                 dx, 0x101
            //   48c744247007000000     | dec    eax
            //   48c744243801000000     | mov    ecx, dword ptr [esp + 0x60]
            //   48c744244807000000     | inc    ecx
            //   48c744244001000000     | mov    al, 1
            //   488d056b400000       | cmp                 dword ptr [eax + 0x4024], 0

        $sequence_5 = { 48898424c8000000 8b442448 48898424d0000000 488b842480000000 4889842498000000 8b442458 48898424a8000000 }
            // n = 7, score = 100
            //   48898424c8000000     | jae                 0x1b62
            //   8b442448             | inc                 ecx
            //   48898424d0000000     | mov                 eax, 0x10
            //   488b842480000000     | dec                 eax
            //   4889842498000000     | mov                 edx, eax
            //   8b442458             | dec                 eax
            //   48898424a8000000     | mov                 eax, dword ptr [esp + 0x78]

        $sequence_6 = { 0f85ae000000 488b442470 8b4038 89442434 837c243400 0f8e92000000 4863442434 }
            // n = 7, score = 100
            //   0f85ae000000         | mov                 eax, dword ptr [esp + 0x28]
            //   488b442470           | dec                 eax
            //   8b4038               | mov                 ecx, dword ptr [esp + 0x78]
            //   89442434             | dec                 eax
            //   837c243400           | add                 ecx, eax
            //   0f8e92000000         | dec                 eax
            //   4863442434           | mov                 eax, ecx

        $sequence_7 = { 488b4c2420 e8???????? 41b80a000000 488b542428 488b842488000000 488b4818 e8???????? }
            // n = 7, score = 100
            //   488b4c2420           | mov                 ecx, dword ptr [esp + 0x20]
            //   e8????????           |                     
            //   41b80a000000         | inc                 esp
            //   488b542428           | mov                 ecx, eax
            //   488b842488000000     | dec                 esp
            //   488b4818             | mov                 eax, dword ptr [esp + 0x20]
            //   e8????????           |                     

        $sequence_8 = { 0fb7542430 488b4c2460 e8???????? 488b442460 0fb74004 89442440 488b4c2460 }
            // n = 7, score = 100
            //   0fb7542430           | mov                 dword ptr [eax + 8], ecx
            //   488b4c2460           | dec                 eax
            //   e8????????           |                     
            //   488b442460           | mov                 eax, dword ptr [esp + 0x30]
            //   0fb74004             | mov                 ecx, dword ptr [esp + 0x38]
            //   89442440             | mov                 dword ptr [eax + 0xc], ecx
            //   488b4c2460           | dec                 eax

        $sequence_9 = { e8???????? 488b442460 0fb74004 66ffc8 488b4c2460 66894104 eb10 }
            // n = 7, score = 100
            //   e8????????           |                     
            //   488b442460           | mov                 ecx, dword ptr [esp + 0xc0]
            //   0fb74004             | inc                 ebp
            //   66ffc8               | xor                 eax, eax
            //   488b4c2460           | xor                 edx, edx
            //   66894104             | dec                 eax
            //   eb10                 | mov                 ecx, dword ptr [esp + 0x48]

    condition:
        7 of them and filesize < 107520
}