rule win_misfox_auto {

    meta:
        author = "Felix Bilstein - yara-signator at cocacoding dot com"
        date = "2021-06-10"
        version = "1"
        description = "Detects win.misfox."
        info = "autogenerated rule brought to you by yara-signator"
        tool = "yara-signator v0.6.0"
        signator_config = "callsandjumps;datarefs;binvalue"
        malpedia_reference = "https://malpedia.caad.fkie.fraunhofer.de/details/win.misfox"
        malpedia_rule_date = "20210604"
        malpedia_hash = "be09d5d71e77373c0f538068be31a2ad4c69cfbd"
        malpedia_version = "20210616"
        malpedia_license = "CC BY-SA 4.0"
        malpedia_sharing = "TLP:WHITE"

    /* DISCLAIMER
     * The strings used in this rule have been automatically selected from the
     * disassembly of memory dumps and unpacked files, using YARA-Signator.
     * The code and documentation is published here:
     * https://github.com/fxb-cocacoding/yara-signator
     * As Malpedia is used as data source, please note that for a given
     * number of families, only single samples are documented.
     * This likely impacts the degree of generalization these rules will offer.
     * Take the described generation method also into consideration when you
     * apply the rules in your use cases and assign them confidence levels.
     */


    strings:
        $sequence_0 = { 8b4708 8d5704 8902 8b45b8 52 c70300000000 40 }
            // n = 7, score = 300
            //   8b4708               | mov                 eax, dword ptr [edi + 8]
            //   8d5704               | lea                 edx, dword ptr [edi + 4]
            //   8902                 | mov                 dword ptr [edx], eax
            //   8b45b8               | mov                 eax, dword ptr [ebp - 0x48]
            //   52                   | push                edx
            //   c70300000000         | mov                 dword ptr [ebx], 0
            //   40                   | inc                 eax

        $sequence_1 = { ff37 ff30 ff15???????? 85c0 7469 ff7608 }
            // n = 6, score = 300
            //   ff37                 | push                dword ptr [edi]
            //   ff30                 | push                dword ptr [eax]
            //   ff15????????         |                     
            //   85c0                 | test                eax, eax
            //   7469                 | je                  0x6b
            //   ff7608               | push                dword ptr [esi + 8]

        $sequence_2 = { c1e106 8b048550870110 0fbe440804 83e040 5d }
            // n = 5, score = 300
            //   c1e106               | shl                 ecx, 6
            //   8b048550870110       | mov                 eax, dword ptr [eax*4 + 0x10018750]
            //   0fbe440804           | movsx               eax, byte ptr [eax + ecx + 4]
            //   83e040               | and                 eax, 0x40
            //   5d                   | pop                 ebp

        $sequence_3 = { 8b0c8d50870110 c644390400 85f6 740c 56 }
            // n = 5, score = 300
            //   8b0c8d50870110       | mov                 ecx, dword ptr [ecx*4 + 0x10018750]
            //   c644390400           | mov                 byte ptr [ecx + edi + 4], 0
            //   85f6                 | test                esi, esi
            //   740c                 | je                  0xe
            //   56                   | push                esi

        $sequence_4 = { 8945e0 8d8020770110 8945e4 803800 8bc8 7435 8a4101 }
            // n = 7, score = 300
            //   8945e0               | mov                 dword ptr [ebp - 0x20], eax
            //   8d8020770110         | lea                 eax, dword ptr [eax + 0x10017720]
            //   8945e4               | mov                 dword ptr [ebp - 0x1c], eax
            //   803800               | cmp                 byte ptr [eax], 0
            //   8bc8                 | mov                 ecx, eax
            //   7435                 | je                  0x37
            //   8a4101               | mov                 al, byte ptr [ecx + 1]

        $sequence_5 = { f7fb 83c230 83fa30 7c05 83fa39 }
            // n = 5, score = 300
            //   f7fb                 | idiv                ebx
            //   83c230               | add                 edx, 0x30
            //   83fa30               | cmp                 edx, 0x30
            //   7c05                 | jl                  7
            //   83fa39               | cmp                 edx, 0x39

        $sequence_6 = { 51 8d45e0 8bcf 50 e8???????? 8bc7 8b4df4 }
            // n = 7, score = 300
            //   51                   | push                ecx
            //   8d45e0               | lea                 eax, dword ptr [ebp - 0x20]
            //   8bcf                 | mov                 ecx, edi
            //   50                   | push                eax
            //   e8????????           |                     
            //   8bc7                 | mov                 eax, edi
            //   8b4df4               | mov                 ecx, dword ptr [ebp - 0xc]

        $sequence_7 = { 8b00 6a00 6a00 6a03 6a00 6a00 68bb010000 }
            // n = 7, score = 300
            //   8b00                 | mov                 eax, dword ptr [eax]
            //   6a00                 | push                0
            //   6a00                 | push                0
            //   6a03                 | push                3
            //   6a00                 | push                0
            //   6a00                 | push                0
            //   68bb010000           | push                0x1bb

        $sequence_8 = { eb03 498bc4 488d1575410100 488bc8 e8???????? }
            // n = 5, score = 100
            //   eb03                 | mov                 byte ptr [ebp + 0x30], dh
            //   498bc4               | dec                 eax
            //   488d1575410100       | mov                 dword ptr [ebp + 0x68], 0xf
            //   488bc8               | dec                 esp
            //   e8????????           |                     

        $sequence_9 = { 488985c0000000 488985c8000000 e8???????? 2507000080 7d07 ffc8 }
            // n = 6, score = 100
            //   488985c0000000       | dec                 eax
            //   488985c8000000       | lea                 eax, dword ptr [0x145bf]
            //   e8????????           |                     
            //   2507000080           | dec                 eax
            //   7d07                 | mov                 dword ptr [ecx + 0xb8], eax
            //   ffc8                 | dec                 eax

        $sequence_10 = { 83e21f 4c8d0520d10000 498b0cc8 486bd258 }
            // n = 4, score = 100
            //   83e21f               | mov                 dword ptr [ebp + 0x60], esi
            //   4c8d0520d10000       | jmp                 5
            //   498b0cc8             | dec                 ecx
            //   486bd258             | mov                 eax, esp

        $sequence_11 = { 83fb0a 7cd1 48c745480f000000 4c897540 44887530 48c745680f000000 4c897560 }
            // n = 7, score = 100
            //   83fb0a               | cmp                 ebx, 0xa
            //   7cd1                 | jl                  0xffffffd3
            //   48c745480f000000     | dec                 eax
            //   4c897540             | mov                 dword ptr [ebp + 0x48], 0xf
            //   44887530             | dec                 esp
            //   48c745680f000000     | mov                 dword ptr [ebp + 0x40], esi
            //   4c897560             | inc                 esp

        $sequence_12 = { 488b4ddf 4533c9 33d2 458d4104 4489742420 }
            // n = 5, score = 100
            //   488b4ddf             | mov                 ecx, dword ptr [eax + ecx*8]
            //   4533c9               | dec                 eax
            //   33d2                 | imul                edx, edx, 0x58
            //   458d4104             | mov                 word ptr [ecx + 0x164], ax
            //   4489742420           | mov                 word ptr [ecx + 0x26a], ax

        $sequence_13 = { 488b55bf 488b4dff ff15???????? 85c0 7516 }
            // n = 5, score = 100
            //   488b55bf             | and                 edx, 0x1f
            //   488b4dff             | dec                 esp
            //   ff15????????         |                     
            //   85c0                 | lea                 eax, dword ptr [0xd120]
            //   7516                 | dec                 ecx

        $sequence_14 = { 66898164010000 6689816a020000 488d05bf450100 488981b8000000 }
            // n = 4, score = 100
            //   66898164010000       | dec                 eax
            //   6689816a020000       | lea                 edx, dword ptr [0x14175]
            //   488d05bf450100       | dec                 eax
            //   488981b8000000       | mov                 ecx, eax

        $sequence_15 = { ff15???????? 85c0 0f85f2000000 8b4db7 8d41ff 83f801 }
            // n = 6, score = 100
            //   ff15????????         |                     
            //   85c0                 | test                eax, eax
            //   0f85f2000000         | jne                 0xf8
            //   8b4db7               | mov                 ecx, dword ptr [ebp - 0x49]
            //   8d41ff               | lea                 eax, dword ptr [ecx - 1]
            //   83f801               | cmp                 eax, 1

    condition:
        7 of them and filesize < 266240
}