rule win_coinminer_auto {

    meta:
        author = "Felix Bilstein - yara-signator at cocacoding dot com"
        date = "2022-04-08"
        version = "1"
        description = "Describes win.coinminer."
        info = "autogenerated rule brought to you by yara-signator"
        tool = "yara-signator v0.6.0"
        signator_config = "callsandjumps;datarefs;binvalue"
        malpedia_reference = "https://malpedia.caad.fkie.fraunhofer.de/details/win.coinminer"
        malpedia_rule_date = "20220405"
        malpedia_hash = "ecd38294bd47d5589be5cd5490dc8bb4804afc2a"
        malpedia_version = ""
        malpedia_license = "CC BY-SA 4.0"
        malpedia_sharing = "TLP:WHITE"

    /* DISCLAIMER
     * The strings used in this rule have been automatically selected from the
     * disassembly of memory dumps and unpacked files, using YARA-Signator.
     * The code and documentation is published here:
     * https://github.com/fxb-cocacoding/yara-signator
     * As Malpedia is used as data source, please note that for a given
     * number of families, only single samples are documented.
     * This likely impacts the degree of generalization these rules will offer.
     * Take the described generation method also into consideration when you
     * apply the rules in your use cases and assign them confidence levels.
     */


    strings:
        $sequence_0 = { 85d2 750d 8b45f8 8b55fc 5f 5e }
            // n = 6, score = 100
            //   85d2                 | test                edx, edx
            //   750d                 | jne                 0xf
            //   8b45f8               | mov                 eax, dword ptr [ebp - 8]
            //   8b55fc               | mov                 edx, dword ptr [ebp - 4]
            //   5f                   | pop                 edi
            //   5e                   | pop                 esi

        $sequence_1 = { 66c745f60000 660fd645ea 8955f4 8d5601 8945f0 8a06 }
            // n = 6, score = 100
            //   66c745f60000         | mov                 word ptr [ebp - 0xa], 0
            //   660fd645ea           | movq                qword ptr [ebp - 0x16], xmm0
            //   8955f4               | mov                 dword ptr [ebp - 0xc], edx
            //   8d5601               | lea                 edx, dword ptr [esi + 1]
            //   8945f0               | mov                 dword ptr [ebp - 0x10], eax
            //   8a06                 | mov                 al, byte ptr [esi]

        $sequence_2 = { 391cfdd85b9000 7518 53 68a00f0000 56 }
            // n = 5, score = 100
            //   391cfdd85b9000       | cmp                 dword ptr [edi*8 + 0x905bd8], ebx
            //   7518                 | jne                 0x1a
            //   53                   | push                ebx
            //   68a00f0000           | push                0xfa0
            //   56                   | push                esi

        $sequence_3 = { 57 41 752f a0???????? c157060e 85940ab157bf0e 1d0fa1f0a7 }
            // n = 7, score = 100
            //   57                   | push                edi
            //   41                   | inc                 ecx
            //   752f                 | jne                 0x31
            //   a0????????           |                     
            //   c157060e             | rcl                 dword ptr [edi + 6], 0xe
            //   85940ab157bf0e       | test                dword ptr [edx + ecx + 0xebf57b1], edx
            //   1d0fa1f0a7           | sbb                 eax, 0xa7f0a10f

        $sequence_4 = { 85c0 753f 8bce 8d5102 8da42400000000 668b01 83c102 }
            // n = 7, score = 100
            //   85c0                 | test                eax, eax
            //   753f                 | jne                 0x41
            //   8bce                 | mov                 ecx, esi
            //   8d5102               | lea                 edx, dword ptr [ecx + 2]
            //   8da42400000000       | lea                 esp, dword ptr [esp]
            //   668b01               | mov                 ax, word ptr [ecx]
            //   83c102               | add                 ecx, 2

        $sequence_5 = { 75f5 8bce 2bd7 d1fa 8d7902 668b01 83c102 }
            // n = 7, score = 100
            //   75f5                 | jne                 0xfffffff7
            //   8bce                 | mov                 ecx, esi
            //   2bd7                 | sub                 edx, edi
            //   d1fa                 | sar                 edx, 1
            //   8d7902               | lea                 edi, dword ptr [ecx + 2]
            //   668b01               | mov                 ax, word ptr [ecx]
            //   83c102               | add                 ecx, 2

        $sequence_6 = { c744243b00000000 f3a5 f30f7f442460 c644243f00 33c0 0f57c0 }
            // n = 6, score = 100
            //   c744243b00000000     | mov                 dword ptr [esp + 0x3b], 0
            //   f3a5                 | rep movsd           dword ptr es:[edi], dword ptr [esi]
            //   f30f7f442460         | movdqu              xmmword ptr [esp + 0x60], xmm0
            //   c644243f00           | mov                 byte ptr [esp + 0x3f], 0
            //   33c0                 | xor                 eax, eax
            //   0f57c0               | xorps               xmm0, xmm0

        $sequence_7 = { 33c9 eb05 1bc9 83c901 a1???????? 85c9 }
            // n = 6, score = 100
            //   33c9                 | xor                 ecx, ecx
            //   eb05                 | jmp                 7
            //   1bc9                 | sbb                 ecx, ecx
            //   83c901               | or                  ecx, 1
            //   a1????????           |                     
            //   85c9                 | test                ecx, ecx

        $sequence_8 = { 7523 e8???????? 8bf8 8bca 893d???????? }
            // n = 5, score = 100
            //   7523                 | jne                 0x25
            //   e8????????           |                     
            //   8bf8                 | mov                 edi, eax
            //   8bca                 | mov                 ecx, edx
            //   893d????????         |                     

        $sequence_9 = { 0a32 04c9 6b0f61 65ce f25a 94 1e }
            // n = 7, score = 100
            //   0a32                 | or                  dh, byte ptr [edx]
            //   04c9                 | add                 al, 0xc9
            //   6b0f61               | imul                ecx, dword ptr [edi], 0x61
            //   65ce                 | into                
            //   f25a                 | pop                 edx
            //   94                   | xchg                eax, esp
            //   1e                   | push                ds

    condition:
        7 of them and filesize < 1523712
}