rule win_komprogo_auto {

    meta:
        author = "Felix Bilstein - yara-signator at cocacoding dot com"
        date = "2022-11-21"
        version = "1"
        description = "Detects win.komprogo."
        info = "autogenerated rule brought to you by yara-signator"
        tool = "yara-signator v0.6.0"
        signator_config = "callsandjumps;datarefs;binvalue"
        malpedia_reference = "https://malpedia.caad.fkie.fraunhofer.de/details/win.komprogo"
        malpedia_rule_date = "20221118"
        malpedia_hash = "e0702e2e6d1d00da65c8a29a4ebacd0a4c59e1af"
        malpedia_version = "20221125"
        malpedia_license = "CC BY-SA 4.0"
        malpedia_sharing = "TLP:WHITE"

    /* DISCLAIMER
     * The strings used in this rule have been automatically selected from the
     * disassembly of memory dumps and unpacked files, using YARA-Signator.
     * The code and documentation is published here:
     * https://github.com/fxb-cocacoding/yara-signator
     * As Malpedia is used as data source, please note that for a given
     * number of families, only single samples are documented.
     * This likely impacts the degree of generalization these rules will offer.
     * Take the described generation method also into consideration when you
     * apply the rules in your use cases and assign them confidence levels.
     */


    strings:
        $sequence_0 = { 8986acac0300 8d8e705d0300 898eccac0300 8d8604710300 898660340000 8d96805d0300 8996dcac0300 }
            // n = 7, score = 100
            //   8986acac0300         | mov                 dword ptr [esi + 0x3acac], eax
            //   8d8e705d0300         | lea                 ecx, [esi + 0x35d70]
            //   898eccac0300         | mov                 dword ptr [esi + 0x3accc], ecx
            //   8d8604710300         | lea                 eax, [esi + 0x37104]
            //   898660340000         | mov                 dword ptr [esi + 0x3460], eax
            //   8d96805d0300         | lea                 edx, [esi + 0x35d80]
            //   8996dcac0300         | mov                 dword ptr [esi + 0x3acdc], edx

        $sequence_1 = { 8986e7760200 8d86684a0400 8986ef760200 8d8634710300 89865f770200 8d8e27930200 }
            // n = 6, score = 100
            //   8986e7760200         | mov                 dword ptr [esi + 0x276e7], eax
            //   8d86684a0400         | lea                 eax, [esi + 0x44a68]
            //   8986ef760200         | mov                 dword ptr [esi + 0x276ef], eax
            //   8d8634710300         | lea                 eax, [esi + 0x37134]
            //   89865f770200         | mov                 dword ptr [esi + 0x2775f], eax
            //   8d8e27930200         | lea                 ecx, [esi + 0x29327]

        $sequence_2 = { 898692e40000 8d96e0910300 8996f8930300 8d86ac950300 89867b590000 8d860c390400 8986d6e40000 }
            // n = 7, score = 100
            //   898692e40000         | mov                 dword ptr [esi + 0xe492], eax
            //   8d96e0910300         | lea                 edx, [esi + 0x391e0]
            //   8996f8930300         | mov                 dword ptr [esi + 0x393f8], edx
            //   8d86ac950300         | lea                 eax, [esi + 0x395ac]
            //   89867b590000         | mov                 dword ptr [esi + 0x597b], eax
            //   8d860c390400         | lea                 eax, [esi + 0x4390c]
            //   8986d6e40000         | mov                 dword ptr [esi + 0xe4d6], eax

        $sequence_3 = { 8d8efc920200 898ed4920200 8d8ee0700300 51 8b4dfc }
            // n = 5, score = 100
            //   8d8efc920200         | lea                 ecx, [esi + 0x292fc]
            //   898ed4920200         | mov                 dword ptr [esi + 0x292d4], ecx
            //   8d8ee0700300         | lea                 ecx, [esi + 0x370e0]
            //   51                   | push                ecx
            //   8b4dfc               | mov                 ecx, dword ptr [ebp - 4]

        $sequence_4 = { 898664b20300 8d8e33ec0000 898e7cb20300 8d86f0380400 8986e5380200 8d86d4ed0300 898682100300 }
            // n = 7, score = 100
            //   898664b20300         | mov                 dword ptr [esi + 0x3b264], eax
            //   8d8e33ec0000         | lea                 ecx, [esi + 0xec33]
            //   898e7cb20300         | mov                 dword ptr [esi + 0x3b27c], ecx
            //   8d86f0380400         | lea                 eax, [esi + 0x438f0]
            //   8986e5380200         | mov                 dword ptr [esi + 0x238e5], eax
            //   8d86d4ed0300         | lea                 eax, [esi + 0x3edd4]
            //   898682100300         | mov                 dword ptr [esi + 0x31082], eax

        $sequence_5 = { 5f b83f000000 663b06 5e 7405 e8???????? 5b }
            // n = 7, score = 100
            //   5f                   | pop                 edi
            //   b83f000000           | mov                 eax, 0x3f
            //   663b06               | cmp                 ax, word ptr [esi]
            //   5e                   | pop                 esi
            //   7405                 | je                  7
            //   e8????????           |                     
            //   5b                   | pop                 ebx

        $sequence_6 = { 898e6b330100 898e9d340100 898e3c360100 898e34370100 8d8ef4700300 898e84310000 8d8e50600300 }
            // n = 7, score = 100
            //   898e6b330100         | mov                 dword ptr [esi + 0x1336b], ecx
            //   898e9d340100         | mov                 dword ptr [esi + 0x1349d], ecx
            //   898e3c360100         | mov                 dword ptr [esi + 0x1363c], ecx
            //   898e34370100         | mov                 dword ptr [esi + 0x13734], ecx
            //   8d8ef4700300         | lea                 ecx, [esi + 0x370f4]
            //   898e84310000         | mov                 dword ptr [esi + 0x3184], ecx
            //   8d8e50600300         | lea                 ecx, [esi + 0x36050]

        $sequence_7 = { 0002 56 52 8d4710 50 e8???????? }
            // n = 6, score = 100
            //   0002                 | add                 byte ptr [edx], al
            //   56                   | push                esi
            //   52                   | push                edx
            //   8d4710               | lea                 eax, [edi + 0x10]
            //   50                   | push                eax
            //   e8????????           |                     

        $sequence_8 = { 8d8e54910300 898e14940300 8d86cc940200 8986a2930200 8d867c940200 8986ad930200 8d96d0930200 }
            // n = 7, score = 100
            //   8d8e54910300         | lea                 ecx, [esi + 0x39154]
            //   898e14940300         | mov                 dword ptr [esi + 0x39414], ecx
            //   8d86cc940200         | lea                 eax, [esi + 0x294cc]
            //   8986a2930200         | mov                 dword ptr [esi + 0x293a2], eax
            //   8d867c940200         | lea                 eax, [esi + 0x2947c]
            //   8986ad930200         | mov                 dword ptr [esi + 0x293ad], eax
            //   8d96d0930200         | lea                 edx, [esi + 0x293d0]

        $sequence_9 = { 8996862a0000 8d8614910300 89861c940300 8d86c8380400 8986e8ed0300 898e315e0000 8d86f8980300 }
            // n = 7, score = 100
            //   8996862a0000         | mov                 dword ptr [esi + 0x2a86], edx
            //   8d8614910300         | lea                 eax, [esi + 0x39114]
            //   89861c940300         | mov                 dword ptr [esi + 0x3941c], eax
            //   8d86c8380400         | lea                 eax, [esi + 0x438c8]
            //   8986e8ed0300         | mov                 dword ptr [esi + 0x3ede8], eax
            //   898e315e0000         | mov                 dword ptr [esi + 0x5e31], ecx
            //   8d86f8980300         | lea                 eax, [esi + 0x398f8]

    condition:
        7 of them and filesize < 1045504
}